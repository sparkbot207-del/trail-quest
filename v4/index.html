<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trail Quest v4</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           CSS VARIABLES & BASE
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #10b981;
            --primary-glow: rgba(16, 185, 129, 0.3);
            --secondary: #06b6d4;
            --accent: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            
            --bg-dark: #0a0f1a;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-glass: rgba(30, 41, 59, 0.6);
            --border: rgba(71, 85, 105, 0.5);
            --border-glow: rgba(16, 185, 129, 0.5);
            
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --text-bright: #ffffff;
            
            --radius: 16px;
            --radius-sm: 8px;
        }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        h1, h2, h3, .font-display {
            font-family: 'Russo One', sans-serif;
            letter-spacing: 0.5px;
        }
        
        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ============================================
           GLASSMORPHISM UTILITIES
           ============================================ */
        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
        }
        
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .glow {
            box-shadow: 0 0 20px var(--primary-glow), 0 0 60px rgba(16, 185, 129, 0.1);
        }
        
        /* ============================================
           APP LAYOUT
           ============================================ */
        #app {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 50%, #0f1419 100%);
        }
        
        /* Animated background grid */
        #app::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(16, 185, 129, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }
        
        .screen {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* ============================================
           HEADER
           ============================================ */
        .screen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 10;
        }
        
        .back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            color: var(--text);
            font-size: 1.3rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .back-btn:active {
            transform: scale(0.95);
            background: var(--primary);
        }
        
        .header-title {
            font-size: 1.2rem;
            color: var(--text-bright);
        }
        
        .header-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* ============================================
           TITLE SCREEN
           ============================================ */
        #title-screen {
            justify-content: center;
            align-items: center;
            padding: 24px;
            text-align: center;
            gap: 24px;
        }
        
        .title-logo {
            margin-bottom: 8px;
        }
        
        .title-logo h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 60px var(--primary-glow);
        }
        
        .title-tagline {
            color: var(--text-dim);
            font-size: 1rem;
            margin-top: 8px;
        }
        
        .title-stats {
            display: flex;
            gap: 24px;
            justify-content: center;
            padding: 16px 24px;
            background: var(--bg-glass);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .title-stat {
            text-align: center;
        }
        
        .title-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .title-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .title-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 320px;
        }
        
        .menu-btn {
            padding: 18px 24px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: var(--radius);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .menu-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
            color: var(--bg-dark);
            box-shadow: 0 4px 20px var(--primary-glow);
        }
        
        .menu-btn.secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .menu-btn:active {
            transform: scale(0.98);
        }
        
        .menu-btn .icon {
            font-size: 1.3rem;
        }
        
        /* ============================================
           WEATHER INDICATOR
           ============================================ */
        .weather-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-glass);
            border-radius: 20px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }
        
        .weather-icon {
            font-size: 1.2rem;
        }
        
        /* ============================================
           BIKE SELECTION GRID
           ============================================ */
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .bike-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }
        
        .bike-card {
            aspect-ratio: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }
        
        .bike-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--bike-color, var(--primary)) 0%, transparent 100%);
            opacity: 0.1;
            transition: opacity 0.25s;
        }
        
        .bike-card:active::before,
        .bike-card.selected::before {
            opacity: 0.2;
        }
        
        .bike-card.selected {
            border-color: var(--bike-color, var(--primary));
            box-shadow: 0 0 20px var(--bike-glow, var(--primary-glow));
        }
        
        .bike-card.locked {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .bike-card .lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
        }
        
        .bike-preview {
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bike-preview svg {
            width: 100%;
            height: 100%;
        }
        
        .bike-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-bright);
        }
        
        .bike-type {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        
        .bike-stats-mini {
            display: flex;
            gap: 12px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        
        .bike-stats-mini span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* ============================================
           TRAIL SELECTION
           ============================================ */
        .trail-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .trail-card {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trail-card:active,
        .trail-card.selected {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .trail-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: var(--bg-dark);
            border-radius: var(--radius-sm);
        }
        
        .trail-info {
            flex: 1;
        }
        
        .trail-name {
            font-weight: 600;
            color: var(--text-bright);
        }
        
        .trail-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        
        .trail-length {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* ============================================
           RIDE SCREEN
           ============================================ */
        #ride-screen {
            background: linear-gradient(180deg, #1a3a5c 0%, #0f2942 30%, #0a1929 60%, #050d15 100%);
        }
        
        .ride-world {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* Parallax layers */
        .parallax-layer {
            position: absolute;
            left: 0;
            right: 0;
            background-repeat: repeat-x;
            background-size: auto 100%;
        }
        
        .parallax-sky {
            top: 0;
            height: 40%;
            background: linear-gradient(180deg, #1e3a5f 0%, #2d4a6f 100%);
        }
        
        .parallax-mountains {
            top: 25%;
            height: 30%;
            opacity: 0.6;
        }
        
        .parallax-trees {
            top: 40%;
            height: 35%;
        }
        
        .parallax-ground {
            bottom: 0;
            height: 35%;
            background: linear-gradient(180deg, #1a2f1a 0%, #0f1f0f 100%);
        }
        
        /* Road */
        .road {
            position: absolute;
            bottom: 15%;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            border-top: 3px solid #3d3d3d;
        }
        
        .road-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(90deg, #fcd34d 0px, #fcd34d 30px, transparent 30px, transparent 60px);
            transform: translateY(-50%);
            animation: roadMove 0.5s linear infinite;
        }
        
        @keyframes roadMove {
            from { background-position-x: 0; }
            to { background-position-x: -60px; }
        }
        
        /* Bike on road */
        .ride-bike {
            position: absolute;
            bottom: calc(15% + 50px);
            left: 20%;
            width: 120px;
            height: 80px;
            transition: transform 0.3s;
        }
        
        .ride-bike svg {
            width: 100%;
            height: 100%;
        }
        
        .ride-bike.leaning-up {
            transform: rotate(-5deg);
        }
        
        .ride-bike.leaning-down {
            transform: rotate(5deg);
        }
        
        /* ============================================
           RIDE HUD
           ============================================ */
        .ride-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }
        
        .hud-left, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .hud-panel {
            padding: 12px 16px;
            min-width: 100px;
        }
        
        .hud-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }
        
        .hud-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'Russo One', sans-serif;
        }
        
        .hud-value.speed {
            font-size: 2.2rem;
            color: var(--text-bright);
        }
        
        .hud-value.speed span {
            font-size: 0.9rem;
            color: var(--text-dim);
        }
        
        /* Battery bar */
        .battery-bar-container {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            z-index: 10;
        }
        
        .battery-bar-bg {
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            border: 2px solid var(--border);
            overflow: hidden;
            position: relative;
        }
        
        .battery-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #34d399 100%);
            border-radius: 10px;
            transition: width 0.3s, background 0.3s;
            position: relative;
        }
        
        .battery-bar-fill.warning {
            background: linear-gradient(90deg, var(--accent) 0%, #fbbf24 100%);
        }
        
        .battery-bar-fill.danger {
            background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%);
            animation: batteryPulse 0.5s ease-in-out infinite;
        }
        
        @keyframes batteryPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .battery-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        /* ============================================
           MODE SELECTOR
           ============================================ */
        .mode-selector {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 30px;
            border: 1px solid var(--border);
            z-index: 10;
        }
        
        .mode-btn {
            padding: 10px 18px;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        
        .mode-btn.active {
            color: var(--bg-dark);
        }
        
        .mode-btn[data-mode="eco"].active { background: var(--primary); }
        .mode-btn[data-mode="normal"].active { background: var(--secondary); }
        .mode-btn[data-mode="sport"].active { background: var(--accent); }
        .mode-btn[data-mode="turbo"].active { background: var(--danger); }
        
        /* ============================================
           PROGRESS BAR
           ============================================ */
        .progress-container {
            position: absolute;
            bottom: 140px;
            left: 20px;
            right: 20px;
            z-index: 10;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        
        /* ============================================
           EVENT POPUP
           ============================================ */
        .event-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            padding: 24px 32px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 100;
            max-width: 300px;
        }
        
        .event-popup.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .event-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .event-title {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        
        .event-text {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        
        .event-effect {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .event-effect.positive { color: var(--primary); }
        .event-effect.negative { color: var(--danger); }
        
        /* ============================================
           ACHIEVEMENTS
           ============================================ */
        .achievement-toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .achievement-toast.visible {
            top: 20px;
        }
        
        .achievement-icon {
            font-size: 2rem;
        }
        
        .achievement-info h4 {
            color: var(--accent);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .achievement-info p {
            font-weight: 600;
        }
        
        /* ============================================
           BUTTONS
           ============================================ */
        .btn-ride {
            position: fixed;
            bottom: 24px;
            left: 24px;
            right: 24px;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
            color: var(--bg-dark);
            border-radius: var(--radius);
            box-shadow: 0 4px 20px var(--primary-glow);
            z-index: 100;
            transition: all 0.2s;
        }
        
        .btn-ride:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .btn-ride:active {
            transform: scale(0.98);
        }

        /* ============================================
           SCROLLBAR
           ============================================ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Achievement Toast -->
        <div id="achievement-toast" class="achievement-toast glass-card">
            <div class="achievement-icon">üèÜ</div>
            <div class="achievement-info">
                <h4>Achievement Unlocked</h4>
                <p id="achievement-name">First Ride</p>
            </div>
        </div>

        <!-- ========== TITLE SCREEN ========== -->
        <div id="title-screen" class="screen active">
            <div class="weather-badge">
                <span class="weather-icon" id="weather-icon">‚òÄÔ∏è</span>
                <span id="weather-text">Clear</span>
            </div>
            
            <div class="title-logo">
                <h1>TRAIL QUEST</h1>
                <p class="title-tagline">E-Bike Adventure</p>
            </div>
            
            <div class="title-stats">
                <div class="title-stat">
                    <div class="title-stat-value" id="stat-miles">0</div>
                    <div class="title-stat-label">Miles</div>
                </div>
                <div class="title-stat">
                    <div class="title-stat-value" id="stat-rides">0</div>
                    <div class="title-stat-label">Rides</div>
                </div>
                <div class="title-stat">
                    <div class="title-stat-value" id="stat-money">$500</div>
                    <div class="title-stat-label">Cash</div>
                </div>
            </div>
            
            <div class="title-menu">
                <button class="menu-btn primary" onclick="showScreen('bike-select')">
                    <span class="icon">üö¥</span>
                    <span>Start Ride</span>
                </button>
                <button class="menu-btn secondary" onclick="showScreen('garage')">
                    <span class="icon">üîß</span>
                    <span>Garage</span>
                </button>
                <button class="menu-btn secondary" onclick="showScreen('achievements')">
                    <span class="icon">üèÜ</span>
                    <span>Achievements</span>
                </button>
            </div>
        </div>

        <!-- ========== BIKE SELECT ========== -->
        <div id="bike-select" class="screen">
            <div class="screen-header glass">
                <button class="back-btn" onclick="showScreen('title-screen')">‚Üê</button>
                <h2 class="header-title">Select Bike</h2>
                <div class="header-stats">
                    <span id="header-money">$500</span>
                </div>
            </div>
            <div class="scroll-content">
                <div class="bike-grid" id="bike-grid">
                    <!-- Bikes rendered by JS -->
                </div>
            </div>
            <button class="btn-ride" id="btn-to-trail" onclick="showScreen('trail-select')" disabled>
                Choose Trail ‚Üí
            </button>
        </div>

        <!-- ========== TRAIL SELECT ========== -->
        <div id="trail-select" class="screen">
            <div class="screen-header glass">
                <button class="back-btn" onclick="showScreen('bike-select')">‚Üê</button>
                <h2 class="header-title">Select Trail</h2>
                <div class="header-stats" id="selected-bike-name">Revv1 DRT</div>
            </div>
            <div class="scroll-content">
                <div class="trail-list" id="trail-list">
                    <!-- Trails rendered by JS -->
                </div>
            </div>
            <button class="btn-ride" id="btn-start-ride" onclick="startRide()" disabled>
                Start Ride üöÄ
            </button>
        </div>

        <!-- ========== RIDE SCREEN ========== -->
        <div id="ride-screen" class="screen">
            <!-- Parallax World -->
            <div class="ride-world" id="ride-world">
                <div class="parallax-layer parallax-sky"></div>
                <div class="parallax-layer parallax-ground"></div>
                <div class="road">
                    <div class="road-line" id="road-line"></div>
                </div>
                <div class="ride-bike" id="ride-bike"></div>
            </div>
            
            <!-- HUD -->
            <div class="ride-hud">
                <div class="hud-left">
                    <div class="hud-panel glass-card">
                        <div class="hud-label">Speed</div>
                        <div class="hud-value speed"><span id="hud-speed">0</span> <span>mph</span></div>
                    </div>
                </div>
                <div class="hud-right">
                    <div class="hud-panel glass-card">
                        <div class="hud-label">Distance</div>
                        <div class="hud-value" id="hud-distance">0.0 mi</div>
                    </div>
                    <div class="hud-panel glass-card">
                        <div class="hud-label">Time</div>
                        <div class="hud-value" id="hud-time">0:00</div>
                    </div>
                </div>
            </div>
            
            <!-- Progress -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-labels">
                    <span id="progress-start">Start</span>
                    <span id="progress-end">14 mi</span>
                </div>
            </div>
            
            <!-- Battery -->
            <div class="battery-bar-container">
                <div class="battery-bar-bg">
                    <div class="battery-bar-fill" id="battery-fill" style="width: 100%"></div>
                    <div class="battery-text" id="battery-text">100%</div>
                </div>
            </div>
            
            <!-- Mode Selector -->
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="eco" onclick="setMode('eco')">ECO</button>
                <button class="mode-btn" data-mode="normal" onclick="setMode('normal')">NORM</button>
                <button class="mode-btn" data-mode="sport" onclick="setMode('sport')">SPORT</button>
                <button class="mode-btn" data-mode="turbo" onclick="setMode('turbo')">TURBO</button>
            </div>
            
            <!-- Event Popup -->
            <div class="event-popup glass-card" id="event-popup">
                <div class="event-icon" id="event-icon">ü¶å</div>
                <div class="event-title" id="event-title">Wildlife Encounter</div>
                <div class="event-text" id="event-text">A deer watches from the treeline.</div>
                <div class="event-effect" id="event-effect">No Effect</div>
            </div>
        </div>

        <!-- ========== GARAGE ========== -->
        <div id="garage" class="screen">
            <div class="screen-header glass">
                <button class="back-btn" onclick="showScreen('title-screen')">‚Üê</button>
                <h2 class="header-title">Garage</h2>
                <div class="header-stats" id="garage-money">$500</div>
            </div>
            <div class="scroll-content">
                <p style="color: var(--text-dim); text-align: center; padding: 40px;">
                    Upgrades coming soon! üîß
                </p>
            </div>
        </div>

        <!-- ========== ACHIEVEMENTS ========== -->
        <div id="achievements" class="screen">
            <div class="screen-header glass">
                <button class="back-btn" onclick="showScreen('title-screen')">‚Üê</button>
                <h2 class="header-title">Achievements</h2>
                <div class="header-stats" id="achievement-count">0/12</div>
            </div>
            <div class="scroll-content" id="achievement-list">
                <!-- Achievements rendered by JS -->
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // GAME DATA - REAL SPECS
    // ============================================
    
    const BIKES = [
        {
            id: 'radrunner',
            name: 'RadRunner Plus',
            brand: 'Rad Power',
            type: 'Utility',
            battery: { voltage: 48, ah: 14, wh: 672 },
            speed: { eco: 12, normal: 16, sport: 20, max: 20 },
            range: { eco: 45, normal: 35, sport: 25 },
            weight: 65,
            price: 0,
            unlockMiles: 0,
            color: '#ef4444',
            description: 'Affordable utility e-bike. Perfect for beginners!'
        },
        {
            id: 'super73rx',
            name: 'Super73 RX',
            brand: 'Super73',
            type: 'Cafe Cruiser',
            battery: { voltage: 52, ah: 18, wh: 960 },
            speed: { eco: 15, normal: 20, sport: 25, max: 28 },
            range: { eco: 75, normal: 50, sport: 38 },
            weight: 75,
            price: 1500,
            unlockMiles: 50,
            color: '#2563eb',
            description: 'Iconic fat-tire cruiser with retro vibes.'
        },
        {
            id: 'revv1',
            name: 'Revv1 DRT',
            brand: 'Revv',
            type: 'Dual Sport',
            battery: { voltage: 72, ah: 36, wh: 2592 },
            speed: { eco: 20, normal: 35, sport: 45, max: 50 },
            range: { eco: 85, normal: 60, sport: 45 },
            weight: 95,
            price: 2500,
            unlockMiles: 100,
            color: '#10b981',
            description: 'Adventure-ready dual sport. Go anywhere!'
        },
        {
            id: 'surron',
            name: 'Sur-Ron X',
            brand: 'Sur-Ron',
            type: 'MX Off-Road',
            battery: { voltage: 60, ah: 40, wh: 2400 },
            speed: { eco: 18, normal: 30, sport: 40, max: 45 },
            range: { eco: 50, normal: 40, sport: 30 },
            weight: 110,
            price: 3000,
            unlockMiles: 150,
            color: '#f59e0b',
            description: 'Lightweight MX beast. Shreds trails!'
        },
        {
            id: 'onyx',
            name: 'ONYX RCR 72V',
            brand: 'ONYX',
            type: 'Speed Demon',
            battery: { voltage: 72, ah: 45, wh: 3240 },
            speed: { eco: 20, normal: 40, sport: 55, max: 60 },
            range: { eco: 120, normal: 70, sport: 45 },
            weight: 130,
            price: 5000,
            unlockMiles: 250,
            color: '#8b5cf6',
            description: 'Moped-class speed monster. Hold on tight!'
        }
    ];

    const TRAILS = [
        { id: 'eastbay', name: 'East Bay Bike Path', state: 'Rhode Island', length: 14, icon: 'üåä', surface: 'Paved', difficulty: 'Easy' },
        { id: 'minuteman', name: 'Minuteman Bikeway', state: 'Massachusetts', length: 11, icon: 'üèõÔ∏è', surface: 'Paved', difficulty: 'Easy' },
        { id: 'capecod', name: 'Cape Cod Rail Trail', state: 'Massachusetts', length: 26, icon: 'üå≤', surface: 'Paved', difficulty: 'Medium' },
        { id: 'burlington', name: 'Burlington Greenway', state: 'Vermont', length: 13, icon: '‚õµ', surface: 'Paved', difficulty: 'Easy' },
        { id: 'eastern', name: 'Eastern Trail', state: 'Maine', length: 29, icon: 'ü¶û', surface: 'Mixed', difficulty: 'Medium' },
        { id: 'airline', name: 'Airline State Park Trail', state: 'Connecticut', length: 50, icon: '‚úàÔ∏è', surface: 'Crushed Stone', difficulty: 'Hard' }
    ];

    const EVENTS = [
        { icon: 'ü¶å', title: 'Wildlife!', text: 'A deer watches from the treeline.', battery: 0 },
        { icon: 'üöß', title: 'Detour!', text: 'Trail construction ahead!', battery: -8 },
        { icon: 'üí®', title: 'Headwind', text: 'Strong gusts slow you down.', battery: -5 },
        { icon: '‚òÄÔ∏è', title: 'Perfect Day', text: 'Ideal conditions!', battery: 5 },
        { icon: 'üßë‚Äçü§ù‚Äçüßë', title: 'Fellow Rider', text: 'They share a charger!', battery: 12 },
        { icon: 'üåßÔ∏è', title: 'Rain Shower', text: 'Quick downpour.', battery: -6 },
        { icon: '‚¨áÔ∏è', title: 'Downhill!', text: 'Regen braking kicks in!', battery: 10 },
        { icon: '‚õ∞Ô∏è', title: 'Hill Climb', text: 'Steep grade ahead.', battery: -10 },
        { icon: '‚òï', title: 'Trail Cafe', text: 'Quick stop for coffee!', battery: 15 },
        { icon: 'üåà', title: 'Rainbow', text: 'Beautiful view!', battery: 3 },
        { icon: 'üõû', title: 'Rough Patch', text: 'Bumpy section.', battery: -4 },
        { icon: 'üéâ', title: 'E-Bike Meetup!', text: 'Local riders say hi!', battery: 5, money: 20 }
    ];

    const ACHIEVEMENTS = [
        { id: 'first_ride', name: 'First Ride', desc: 'Complete your first trail', icon: 'üö¥', unlocked: false },
        { id: 'century', name: 'Century Club', desc: 'Ride 100 total miles', icon: 'üíØ', unlocked: false },
        { id: 'speed_demon', name: 'Speed Demon', desc: 'Hit 50+ mph', icon: '‚ö°', unlocked: false },
        { id: 'eco_warrior', name: 'Eco Warrior', desc: 'Complete a trail in ECO mode only', icon: 'üå±', unlocked: false },
        { id: 'marathoner', name: 'Marathoner', desc: 'Complete the 50-mile Airline Trail', icon: 'üèÖ', unlocked: false },
        { id: 'collector', name: 'Collector', desc: 'Own 3 different bikes', icon: 'üèçÔ∏è', unlocked: false },
        { id: 'close_call', name: 'Close Call', desc: 'Finish with under 5% battery', icon: 'üò∞', unlocked: false },
        { id: 'perfect', name: 'Perfect Run', desc: 'Finish with 50%+ battery', icon: 'üéØ', unlocked: false },
        { id: 'all_trails', name: 'Trail Master', desc: 'Complete all 6 trails', icon: 'üó∫Ô∏è', unlocked: false },
        { id: 'night_rider', name: 'Night Rider', desc: 'Ride after dark', icon: 'üåô', unlocked: false },
        { id: 'rain_rider', name: 'Rain Rider', desc: 'Complete a ride in rain', icon: 'üåßÔ∏è', unlocked: false },
        { id: 'big_spender', name: 'Big Spender', desc: 'Spend $5000 total', icon: 'üí∞', unlocked: false }
    ];

    const WEATHER = [
        { id: 'clear', icon: '‚òÄÔ∏è', name: 'Clear', rangeModifier: 1.1, speedModifier: 1.0 },
        { id: 'cloudy', icon: '‚òÅÔ∏è', name: 'Cloudy', rangeModifier: 1.0, speedModifier: 1.0 },
        { id: 'rain', icon: 'üåßÔ∏è', name: 'Rain', rangeModifier: 0.85, speedModifier: 0.9 },
        { id: 'windy', icon: 'üí®', name: 'Windy', rangeModifier: 0.8, speedModifier: 0.85 }
    ];

    // ============================================
    // BIKE SVGs
    // ============================================
    
    const BIKE_SVGS = {
        radrunner: `<svg viewBox="0 0 200 120" fill="none"><circle cx="42" cy="82" r="22" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="2"/><circle cx="155" cy="82" r="22" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="2"/><path d="M42 82 L55 55 L130 55 L155 82" stroke="var(--bike-color)" stroke-width="5" stroke-linecap="round"/><path d="M55 55 L55 82" stroke="var(--bike-color)" stroke-width="5" stroke-linecap="round"/><rect x="35" y="55" width="35" height="6" rx="2" fill="#3d3d5c"/><rect x="58" y="58" width="35" height="10" rx="3" fill="#0f172a" stroke="var(--bike-color)" stroke-width="1"/><ellipse cx="55" cy="48" rx="12" ry="5" fill="#1a1a2e"/><path d="M130 55 L142 40" stroke="#4a4a6a" stroke-width="4" stroke-linecap="round"/><path d="M135 35 L150 38" stroke="#1a1a2e" stroke-width="5" stroke-linecap="round"/><rect x="145" y="55" width="18" height="15" rx="2" stroke="#3d3d5c" stroke-width="2" fill="none"/><circle cx="42" cy="82" r="10" fill="#2d2d44" stroke="#4a4a6a" stroke-width="2"/><circle cx="85" cy="78" r="6" fill="#3d3d5c"/></svg>`,
        
        super73rx: `<svg viewBox="0 0 200 120" fill="none"><circle cx="40" cy="80" r="28" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="3"/><circle cx="40" cy="80" r="20" fill="#2d2d44"/><circle cx="40" cy="80" r="24" fill="none" stroke="#4a4a6a" stroke-width="6" stroke-dasharray="4 3"/><circle cx="155" cy="80" r="28" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="3"/><circle cx="155" cy="80" r="20" fill="#2d2d44"/><circle cx="155" cy="80" r="24" fill="none" stroke="#4a4a6a" stroke-width="6" stroke-dasharray="4 3"/><path d="M40 80 L65 45 L130 45 L155 80" stroke="var(--bike-color)" stroke-width="6" stroke-linecap="round"/><path d="M40 80 L90 55" stroke="var(--bike-color)" stroke-width="5" stroke-linecap="round"/><rect x="70" y="48" width="50" height="14" rx="4" fill="#1e293b" stroke="var(--bike-color)" stroke-width="1"/><ellipse cx="75" cy="38" rx="18" ry="6" fill="#1a1a2e"/><path d="M130 45 L145 30" stroke="#4a4a6a" stroke-width="4" stroke-linecap="round"/><path d="M138 28 L152 32" stroke="#1a1a2e" stroke-width="6" stroke-linecap="round"/><circle cx="160" cy="55" r="6" fill="#fef3c7"/><circle cx="40" cy="80" r="12" fill="#2d2d44" stroke="#4a4a6a" stroke-width="2"/></svg>`,
        
        revv1: `<svg viewBox="0 0 200 120" fill="none"><circle cx="38" cy="80" r="25" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="2"/><circle cx="38" cy="80" r="18" fill="#2d2d44"/><circle cx="38" cy="80" r="22" fill="none" stroke="#4a4a6a" stroke-width="4" stroke-dasharray="5 3"/><circle cx="158" cy="80" r="25" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="2"/><circle cx="158" cy="80" r="18" fill="#2d2d44"/><circle cx="158" cy="80" r="22" fill="none" stroke="#4a4a6a" stroke-width="4" stroke-dasharray="5 3"/><path d="M38 80 L55 48 L90 38 L135 42 L158 80" stroke="var(--bike-color)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/><path d="M55 48 L88 68 L135 42" stroke="var(--bike-color)" stroke-width="5" stroke-linecap="round"/><path d="M60 50 L100 40 L95 65 Z" fill="#0f172a" stroke="var(--bike-color)" stroke-width="1"/><path d="M52 42 L100 35 L105 40 L52 48 Z" fill="#1a1a2e"/><path d="M135 42 L150 30 L158 80" stroke="#4a4a6a" stroke-width="4"/><path d="M150 30 L155 18" stroke="#4a4a6a" stroke-width="4" stroke-linecap="round"/><path d="M145 15 L165 20" stroke="#1a1a2e" stroke-width="5" stroke-linecap="round"/><path d="M143 12 Q155 8 167 16" stroke="var(--bike-color)" stroke-width="2" fill="none"/><circle cx="162" cy="52" r="7" fill="#fef3c7"/><circle cx="88" cy="68" r="11" fill="#2d2d44" stroke="#4a4a6a" stroke-width="2"/></svg>`,
        
        surron: `<svg viewBox="0 0 200 120" fill="none"><circle cx="35" cy="82" r="24" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="2"/><circle cx="35" cy="82" r="17" fill="#2d2d44"/><circle cx="35" cy="82" r="21" fill="none" stroke="#4a4a6a" stroke-width="4" stroke-dasharray="3 4"/><circle cx="160" cy="82" r="24" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="2"/><circle cx="160" cy="82" r="17" fill="#2d2d44"/><circle cx="160" cy="82" r="21" fill="none" stroke="#4a4a6a" stroke-width="4" stroke-dasharray="3 4"/><path d="M35 82 L50 45 L80 35 L130 38 L145 50 L160 82" stroke="var(--bike-color)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/><path d="M50 45 L90 65 L130 38" stroke="var(--bike-color)" stroke-width="4" stroke-linecap="round"/><rect x="55" y="38" width="50" height="12" rx="3" fill="#0f172a" stroke="var(--bike-color)" stroke-width="1"/><path d="M45 32 L110 28 L115 32 L45 36 Z" fill="#1a1a2e"/><path d="M145 50 L155 35 L165 82" stroke="#4a4a6a" stroke-width="4" fill="none"/><path d="M145 50 L150 35 L160 82" stroke="#5a5a7a" stroke-width="3" fill="none"/><path d="M155 35 L160 22" stroke="#4a4a6a" stroke-width="4" stroke-linecap="round"/><path d="M150 18 L170 22" stroke="#1a1a2e" stroke-width="5" stroke-linecap="round"/><ellipse cx="140" cy="42" rx="12" ry="8" fill="var(--bike-color)" opacity="0.3"/><circle cx="90" cy="65" r="12" fill="#2d2d44" stroke="#4a4a6a" stroke-width="2"/><path d="M90 65 L35 82" stroke="#3d3d5c" stroke-width="4"/></svg>`,
        
        onyx: `<svg viewBox="0 0 200 120" fill="none"><circle cx="38" cy="78" r="26" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="3"/><circle cx="38" cy="78" r="18" fill="#2d2d44"/><circle cx="158" cy="78" r="26" fill="#1a1a2e" stroke="#3d3d5c" stroke-width="3"/><circle cx="158" cy="78" r="18" fill="#2d2d44"/><path d="M38 78 L55 50 L85 40 L135 40 L158 78" stroke="var(--bike-color)" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/><path d="M55 50 L85 70 L135 40" stroke="var(--bike-color)" stroke-width="6" stroke-linecap="round"/><rect x="60" y="42" width="65" height="22" rx="4" fill="#0f172a" stroke="var(--bike-color)" stroke-width="2"/><text x="92" y="57" font-size="10" fill="var(--bike-color)" text-anchor="middle" font-family="monospace">72V</text><rect x="50" y="30" width="55" height="10" rx="5" fill="#1a1a2e"/><path d="M135 40 L155 25" stroke="#4a4a6a" stroke-width="5" stroke-linecap="round"/><path d="M145 22 L165 28" stroke="#1a1a2e" stroke-width="7" stroke-linecap="round"/><circle cx="160" cy="48" r="5" fill="#fef3c7"/><circle cx="168" cy="52" r="4" fill="#fef3c7"/><circle cx="85" cy="70" r="14" fill="#2d2d44" stroke="#4a4a6a" stroke-width="3"/><circle cx="85" cy="70" r="8" fill="#3d3d5c"/><path d="M38 78 L85 70" stroke="#3d3d5c" stroke-width="3"/><path d="M20 60 Q38 52 56 60" stroke="#1e293b" stroke-width="4" fill="none"/></svg>`
    };

    // ============================================
    // GAME STATE
    // ============================================
    
    let player = {
        money: 500,
        ownedBikes: ['radrunner'],
        currentBike: 'radrunner',
        totalMiles: 0,
        totalRides: 0,
        totalSpent: 0,
        completedTrails: [],
        achievements: []
    };

    let weather = WEATHER[0];
    
    let selection = {
        bike: null,
        trail: null
    };

    let ride = {
        bike: null,
        trail: null,
        battery: 100,
        distance: 0,
        time: 0,
        speed: 0,
        topSpeed: 0,
        mode: 'eco',
        modeChanged: false,
        running: false
    };

    let gameLoop = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    
    function init() {
        loadPlayer();
        randomizeWeather();
        renderBikes();
        renderTrails();
        renderAchievements();
        updateTitleStats();
        console.log('Trail Quest v4 initialized! ‚ö°');
    }

    function loadPlayer() {
        try {
            const saved = localStorage.getItem('trailquest_v4');
            if (saved) {
                player = { ...player, ...JSON.parse(saved) };
            }
        } catch (e) {
            console.warn('Failed to load save:', e);
        }
    }

    function savePlayer() {
        try {
            localStorage.setItem('trailquest_v4', JSON.stringify(player));
        } catch (e) {
            console.warn('Failed to save:', e);
        }
    }

    function randomizeWeather() {
        const hour = new Date().getHours();
        // More chance of rain in evening
        const weights = hour > 18 || hour < 6 ? [2, 3, 3, 2] : [4, 3, 1, 2];
        const total = weights.reduce((a, b) => a + b);
        let rand = Math.random() * total;
        for (let i = 0; i < WEATHER.length; i++) {
            rand -= weights[i];
            if (rand <= 0) {
                weather = WEATHER[i];
                break;
            }
        }
        document.getElementById('weather-icon').textContent = weather.icon;
        document.getElementById('weather-text').textContent = weather.name;
    }

    // ============================================
    // SCREEN MANAGEMENT
    // ============================================
    
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        
        if (screenId === 'bike-select') {
            selection.bike = player.currentBike;
            renderBikes();
            updateBikeButton();
        }
        if (screenId === 'trail-select') {
            const bike = BIKES.find(b => b.id === selection.bike);
            document.getElementById('selected-bike-name').textContent = bike ? bike.name : '';
        }
        if (screenId === 'title-screen') {
            updateTitleStats();
        }
    }

    function updateTitleStats() {
        document.getElementById('stat-miles').textContent = Math.round(player.totalMiles);
        document.getElementById('stat-rides').textContent = player.totalRides;
        document.getElementById('stat-money').textContent = '$' + player.money;
    }

    // ============================================
    // BIKE SELECTION
    // ============================================
    
    function renderBikes() {
        const grid = document.getElementById('bike-grid');
        grid.innerHTML = BIKES.map(bike => {
            const owned = player.ownedBikes.includes(bike.id);
            const canUnlock = player.totalMiles >= bike.unlockMiles;
            const locked = !owned && !canUnlock;
            const selected = selection.bike === bike.id;
            
            return `
                <div class="bike-card glass-card ${selected ? 'selected' : ''} ${locked ? 'locked' : ''}"
                     style="--bike-color: ${bike.color}; --bike-glow: ${bike.color}40"
                     onclick="selectBike('${bike.id}')">
                    ${locked ? '<div class="lock-icon">üîí</div>' : ''}
                    <div class="bike-preview" style="--bike-color: ${bike.color}">
                        ${BIKE_SVGS[bike.id] || BIKE_SVGS.radrunner}
                    </div>
                    <div class="bike-name">${bike.name}</div>
                    <div class="bike-type">${bike.type}</div>
                    <div class="bike-stats-mini">
                        <span>‚ö°${bike.speed.max}mph</span>
                        <span>üîã${bike.range.normal}mi</span>
                    </div>
                    ${!owned && canUnlock ? `<div style="color: var(--accent); font-size: 0.75rem; margin-top: 4px;">$${bike.price}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    function selectBike(bikeId) {
        const bike = BIKES.find(b => b.id === bikeId);
        const owned = player.ownedBikes.includes(bikeId);
        const canUnlock = player.totalMiles >= bike.unlockMiles;
        
        if (!owned && canUnlock) {
            // Purchase bike
            if (player.money >= bike.price) {
                player.money -= bike.price;
                player.totalSpent += bike.price;
                player.ownedBikes.push(bikeId);
                savePlayer();
                checkAchievements();
            } else {
                return; // Not enough money
            }
        }
        
        if (player.ownedBikes.includes(bikeId)) {
            selection.bike = bikeId;
            player.currentBike = bikeId;
            savePlayer();
            renderBikes();
            updateBikeButton();
            document.getElementById('header-money').textContent = '$' + player.money;
        }
    }

    function updateBikeButton() {
        const btn = document.getElementById('btn-to-trail');
        btn.disabled = !selection.bike;
    }

    // ============================================
    // TRAIL SELECTION
    // ============================================
    
    function renderTrails() {
        const list = document.getElementById('trail-list');
        list.innerHTML = TRAILS.map(trail => {
            const selected = selection.trail === trail.id;
            const completed = player.completedTrails.includes(trail.id);
            
            return `
                <div class="trail-card glass-card ${selected ? 'selected' : ''}"
                     onclick="selectTrail('${trail.id}')">
                    <div class="trail-icon">${trail.icon}</div>
                    <div class="trail-info">
                        <div class="trail-name">${trail.name} ${completed ? '‚úì' : ''}</div>
                        <div class="trail-meta">
                            <span class="trail-length">${trail.length} mi</span>
                            <span>${trail.surface}</span>
                            <span>${trail.state}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectTrail(trailId) {
        selection.trail = trailId;
        renderTrails();
        document.getElementById('btn-start-ride').disabled = false;
        document.getElementById('progress-end').textContent = TRAILS.find(t => t.id === trailId).length + ' mi';
    }

    // ============================================
    // RIDE MECHANICS
    // ============================================
    
    function startRide() {
        const bike = BIKES.find(b => b.id === selection.bike);
        const trail = TRAILS.find(t => t.id === selection.trail);
        
        ride = {
            bike,
            trail,
            battery: 100,
            distance: 0,
            time: 0,
            speed: 0,
            topSpeed: 0,
            mode: 'eco',
            modeChanged: false,
            running: true
        };
        
        // Set up ride screen
        document.getElementById('ride-bike').innerHTML = BIKE_SVGS[bike.id] || BIKE_SVGS.radrunner;
        document.getElementById('ride-bike').querySelector('svg').style.setProperty('--bike-color', bike.color);
        
        // Reset HUD
        updateRideHUD();
        setMode('eco');
        
        showScreen('ride-screen');
        
        // Start game loop
        if (gameLoop) clearInterval(gameLoop);
        gameLoop = setInterval(updateRide, 100);
    }

    function updateRide() {
        if (!ride.running) return;
        
        const bike = ride.bike;
        const mode = ride.mode;
        
        // Target speed based on mode
        const targetSpeed = bike.speed[mode];
        
        // Accelerate/decelerate toward target
        const accelRate = 0.5;
        if (ride.speed < targetSpeed) {
            ride.speed = Math.min(targetSpeed, ride.speed + accelRate);
        } else if (ride.speed > targetSpeed) {
            ride.speed = Math.max(targetSpeed, ride.speed - accelRate * 0.5);
        }
        
        // Apply weather modifier
        ride.speed *= weather.speedModifier;
        
        // Track top speed
        if (ride.speed > ride.topSpeed) {
            ride.topSpeed = ride.speed;
            if (ride.topSpeed >= 50) checkAchievements();
        }
        
        // Distance: speed in mph / 36000 = miles per 100ms
        const milesThisTick = ride.speed / 36000;
        ride.distance += milesThisTick;
        
        // Battery drain based on mode efficiency and weather
        const modeEfficiency = { eco: 0.7, normal: 1.0, sport: 1.3, turbo: 1.7 };
        const baseRange = bike.range[mode] * weather.rangeModifier;
        const drainPerMile = 100 / baseRange;
        ride.battery -= milesThisTick * drainPerMile * modeEfficiency[mode];
        ride.battery = Math.max(0, Math.min(100, ride.battery));
        
        // Time
        ride.time += 0.1;
        
        // Random events (0.2% chance per tick)
        if (Math.random() < 0.002) {
            triggerEvent();
        }
        
        // Road animation speed
        const roadLine = document.getElementById('road-line');
        roadLine.style.animationDuration = Math.max(0.1, 1 - (ride.speed / 60)) + 's';
        
        // Update HUD
        updateRideHUD();
        
        // Check end conditions
        if (ride.distance >= ride.trail.length) {
            endRide(true);
        } else if (ride.battery <= 0) {
            endRide(false);
        }
    }

    function updateRideHUD() {
        document.getElementById('hud-speed').textContent = Math.round(ride.speed);
        document.getElementById('hud-distance').textContent = ride.distance.toFixed(1) + ' mi';
        
        const mins = Math.floor(ride.time / 60);
        const secs = Math.floor(ride.time % 60);
        document.getElementById('hud-time').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        // Battery bar
        const batteryFill = document.getElementById('battery-fill');
        const batteryText = document.getElementById('battery-text');
        batteryFill.style.width = ride.battery + '%';
        batteryText.textContent = Math.round(ride.battery) + '%';
        
        batteryFill.classList.remove('warning', 'danger');
        if (ride.battery < 15) batteryFill.classList.add('danger');
        else if (ride.battery < 30) batteryFill.classList.add('warning');
        
        // Progress
        const progress = (ride.distance / ride.trail.length) * 100;
        document.getElementById('progress-fill').style.width = progress + '%';
    }

    function setMode(mode) {
        ride.mode = mode;
        if (mode !== 'eco') ride.modeChanged = true;
        
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
    }

    function triggerEvent() {
        const event = EVENTS[Math.floor(Math.random() * EVENTS.length)];
        
        const popup = document.getElementById('event-popup');
        document.getElementById('event-icon').textContent = event.icon;
        document.getElementById('event-title').textContent = event.title;
        document.getElementById('event-text').textContent = event.text;
        
        const effectEl = document.getElementById('event-effect');
        if (event.battery > 0) {
            effectEl.textContent = `+${event.battery}% Battery`;
            effectEl.className = 'event-effect positive';
        } else if (event.battery < 0) {
            effectEl.textContent = `${event.battery}% Battery`;
            effectEl.className = 'event-effect negative';
        } else {
            effectEl.textContent = 'No Effect';
            effectEl.className = 'event-effect';
        }
        
        // Apply effect
        ride.battery = Math.max(0, Math.min(100, ride.battery + event.battery));
        if (event.money) player.money += event.money;
        
        // Show popup
        popup.classList.add('visible');
        setTimeout(() => popup.classList.remove('visible'), 2500);
    }

    function endRide(success) {
        ride.running = false;
        if (gameLoop) {
            clearInterval(gameLoop);
            gameLoop = null;
        }
        
        if (success) {
            // Calculate rewards
            const basePay = ride.trail.length * 5;
            const bonusPay = Math.round(ride.battery * 0.5);
            const totalPay = basePay + bonusPay;
            
            player.money += totalPay;
            player.totalMiles += ride.distance;
            player.totalRides++;
            
            if (!player.completedTrails.includes(ride.trail.id)) {
                player.completedTrails.push(ride.trail.id);
            }
            
            savePlayer();
            checkAchievements();
            
            // Show result
            alert(`üéâ Trail Complete!\n\n` +
                  `Distance: ${ride.distance.toFixed(1)} mi\n` +
                  `Time: ${Math.floor(ride.time / 60)}:${Math.floor(ride.time % 60).toString().padStart(2, '0')}\n` +
                  `Top Speed: ${Math.round(ride.topSpeed)} mph\n` +
                  `Battery Left: ${Math.round(ride.battery)}%\n\n` +
                  `Earned: $${totalPay}`);
        } else {
            player.totalMiles += ride.distance;
            savePlayer();
            
            alert(`üîã Battery Dead!\n\n` +
                  `Made it ${ride.distance.toFixed(1)} of ${ride.trail.length} miles.\n\n` +
                  `Tip: Try ECO mode or upgrade your battery!`);
        }
        
        showScreen('title-screen');
    }

    // ============================================
    // ACHIEVEMENTS
    // ============================================
    
    function checkAchievements() {
        const newAchievements = [];
        
        // First Ride
        if (player.totalRides >= 1 && !player.achievements.includes('first_ride')) {
            player.achievements.push('first_ride');
            newAchievements.push('first_ride');
        }
        
        // Century Club
        if (player.totalMiles >= 100 && !player.achievements.includes('century')) {
            player.achievements.push('century');
            newAchievements.push('century');
        }
        
        // Speed Demon
        if (ride.topSpeed >= 50 && !player.achievements.includes('speed_demon')) {
            player.achievements.push('speed_demon');
            newAchievements.push('speed_demon');
        }
        
        // Eco Warrior (completed ride without changing from ECO)
        if (ride.distance >= ride.trail?.length && !ride.modeChanged && !player.achievements.includes('eco_warrior')) {
            player.achievements.push('eco_warrior');
            newAchievements.push('eco_warrior');
        }
        
        // Marathoner
        if (player.completedTrails.includes('airline') && !player.achievements.includes('marathoner')) {
            player.achievements.push('marathoner');
            newAchievements.push('marathoner');
        }
        
        // Collector
        if (player.ownedBikes.length >= 3 && !player.achievements.includes('collector')) {
            player.achievements.push('collector');
            newAchievements.push('collector');
        }
        
        // Close Call
        if (ride.battery > 0 && ride.battery < 5 && ride.distance >= ride.trail?.length && !player.achievements.includes('close_call')) {
            player.achievements.push('close_call');
            newAchievements.push('close_call');
        }
        
        // Perfect Run
        if (ride.battery >= 50 && ride.distance >= ride.trail?.length && !player.achievements.includes('perfect')) {
            player.achievements.push('perfect');
            newAchievements.push('perfect');
        }
        
        // All Trails
        if (player.completedTrails.length >= 6 && !player.achievements.includes('all_trails')) {
            player.achievements.push('all_trails');
            newAchievements.push('all_trails');
        }
        
        // Big Spender
        if (player.totalSpent >= 5000 && !player.achievements.includes('big_spender')) {
            player.achievements.push('big_spender');
            newAchievements.push('big_spender');
        }
        
        // Rain Rider
        if (weather.id === 'rain' && ride.distance >= ride.trail?.length && !player.achievements.includes('rain_rider')) {
            player.achievements.push('rain_rider');
            newAchievements.push('rain_rider');
        }
        
        // Night Rider
        const hour = new Date().getHours();
        if ((hour >= 21 || hour < 5) && ride.distance >= ride.trail?.length && !player.achievements.includes('night_rider')) {
            player.achievements.push('night_rider');
            newAchievements.push('night_rider');
        }
        
        savePlayer();
        
        // Show toast for new achievements
        newAchievements.forEach((id, i) => {
            setTimeout(() => showAchievementToast(id), i * 3000);
        });
    }

    function showAchievementToast(achievementId) {
        const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
        if (!achievement) return;
        
        const toast = document.getElementById('achievement-toast');
        toast.querySelector('.achievement-icon').textContent = achievement.icon;
        document.getElementById('achievement-name').textContent = achievement.name;
        
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    function renderAchievements() {
        const list = document.getElementById('achievement-list');
        list.innerHTML = ACHIEVEMENTS.map(a => {
            const unlocked = player.achievements.includes(a.id);
            return `
                <div class="glass-card" style="padding: 16px; margin-bottom: 12px; opacity: ${unlocked ? 1 : 0.5}">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 2rem;">${unlocked ? a.icon : 'üîí'}</div>
                        <div>
                            <div style="font-weight: 600;">${a.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">${a.desc}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('achievement-count').textContent = `${player.achievements.length}/${ACHIEVEMENTS.length}`;
    }

    // ============================================
    // START
    // ============================================
    
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
