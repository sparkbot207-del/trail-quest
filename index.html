<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trail Quest: New England E-Bike Adventure</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --primary-dim: rgba(0, 255, 136, 0.3);
            --secondary: #00ccff;
            --warning: #ffaa00;
            --danger: #ff4444;
            --gold: #ffd700;
            --bg-dark: #0a0e14;
            --bg-card: rgba(15, 25, 35, 0.95);
            --text: #e8e8e8;
            --text-dim: rgba(255, 255, 255, 0.6);
            --border: rgba(0, 255, 136, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Pixel font for game elements */
        .pixel-text {
            font-family: 'Press Start 2P', cursive;
        }

        /* Background */
        .game-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 204, 255, 0.08) 0%, transparent 50%),
                linear-gradient(180deg, #0a0e14 0%, #0f1923 50%, #0a0e14 100%);
        }

        /* Main Container */
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            min-height: 100vh;
        }

        /* Header */
        .game-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
        }

        .game-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .header-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: var(--primary-dim);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: var(--primary);
            color: var(--bg-dark);
        }

        /* Left Panel - Player Stats */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
            padding: 15px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--primary);
            text-transform: uppercase;
        }

        /* Battery Display */
        .battery-display {
            margin-bottom: 15px;
        }

        .battery-bar-outer {
            height: 35px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 2px solid var(--primary);
            overflow: hidden;
            position: relative;
        }

        .battery-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #00cc6a);
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
        }

        .battery-bar-fill.warning {
            background: linear-gradient(90deg, var(--warning), #ff8800);
        }

        .battery-bar-fill.danger {
            background: linear-gradient(90deg, var(--danger), #cc0000);
            animation: dangerPulse 1s ease-in-out infinite;
        }

        @keyframes dangerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .battery-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 1;
        }

        .battery-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* Inventory */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .inventory-slot:hover {
            border-color: var(--primary);
            background: var(--primary-dim);
        }

        .inventory-slot.empty {
            opacity: 0.3;
        }

        .inventory-slot .item-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.6rem;
            font-family: 'Press Start 2P', cursive;
            color: white;
            text-shadow: 1px 1px 1px black;
        }

        /* Weather Display */
        .weather-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .weather-icon {
            font-size: 2.5rem;
        }

        .weather-info {
            flex: 1;
        }

        .weather-temp {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .weather-desc {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .weather-effect {
            font-size: 0.75rem;
            color: var(--warning);
            margin-top: 5px;
        }

        /* Center - Main Game Screen */
        .main-screen {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .game-screen {
            flex: 1;
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
            padding: 25px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .screen-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            color: var(--primary);
        }

        .screen-subtitle {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .screen-content {
            flex: 1;
            overflow-y: auto;
        }

        .narrative {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: var(--text);
        }

        .narrative .highlight {
            color: var(--primary);
            font-weight: 600;
        }

        .narrative .warning {
            color: var(--warning);
        }

        .narrative .danger {
            color: var(--danger);
        }

        /* Event Box */
        .event-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 204, 255, 0.05));
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }

        .event-box.warning {
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.15), rgba(255, 136, 0, 0.05));
            border-left-color: var(--warning);
        }

        .event-box.danger {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.15), rgba(204, 0, 0, 0.05));
            border-left-color: var(--danger);
        }

        .event-box.gold {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 200, 0, 0.05));
            border-left-color: var(--gold);
        }

        .event-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.65rem;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .event-box.warning .event-title { color: var(--warning); }
        .event-box.danger .event-title { color: var(--danger); }
        .event-box.gold .event-title { color: var(--gold); }

        /* Choices */
        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .choice-btn {
            background: linear-gradient(135deg, var(--primary-dim), rgba(0, 200, 100, 0.1));
            border: 2px solid var(--primary);
            color: var(--text);
            padding: 15px 20px;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .choice-btn:hover:not(:disabled) {
            background: var(--primary);
            color: var(--bg-dark);
            transform: translateX(10px);
            box-shadow: 0 0 20px var(--primary-dim);
        }

        .choice-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .choice-btn.secondary {
            border-color: var(--secondary);
            background: rgba(0, 204, 255, 0.1);
        }

        .choice-btn.secondary:hover:not(:disabled) {
            background: var(--secondary);
        }

        .choice-btn.warning {
            border-color: var(--warning);
            background: rgba(255, 170, 0, 0.1);
        }

        .choice-btn.warning:hover:not(:disabled) {
            background: var(--warning);
        }

        .choice-btn.danger {
            border-color: var(--danger);
            background: rgba(255, 68, 68, 0.1);
        }

        .choice-btn.danger:hover:not(:disabled) {
            background: var(--danger);
        }

        .choice-cost {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .choice-btn:hover .choice-cost {
            color: var(--bg-dark);
        }

        /* Trail Card */
        .trail-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .trail-card:hover {
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.05);
        }

        .trail-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .trail-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--primary);
        }

        .trail-difficulty {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .trail-difficulty.easy {
            background: rgba(0, 255, 136, 0.2);
            color: var(--primary);
        }

        .trail-difficulty.moderate {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        .trail-difficulty.hard {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }

        .trail-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .trail-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            font-style: italic;
        }

        .trail-rating {
            color: var(--gold);
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .progress-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 9px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2), transparent);
            border-radius: 9px 9px 0 0;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Mini Map */
        .mini-map {
            height: 200px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .mini-map-trail {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
        }

        .mini-map-progress {
            position: absolute;
            top: 50%;
            left: 10%;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .mini-map-rider {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            transition: left 0.5s ease;
            z-index: 2;
        }

        .mini-map-start, .mini-map-end {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .mini-map-start { left: 5%; }
        .mini-map-end { right: 5%; }

        .mini-map-chargers {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .mini-map-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .achievement {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .achievement.unlocked {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .achievement.locked {
            filter: grayscale(100%);
            opacity: 0.4;
        }

        .achievement:hover {
            transform: scale(1.1);
        }

        .achievement-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        .achievement:hover .achievement-tooltip {
            opacity: 1;
        }

        /* Shop Items */
        .shop-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shop-item:hover:not(.owned) {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .shop-item.owned {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item-icon {
            font-size: 2rem;
        }

        .shop-item-info {
            flex: 1;
        }

        .shop-item-name {
            font-weight: 600;
            color: var(--text);
        }

        .shop-item-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .shop-item-price {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: var(--gold);
        }

        /* Bike Selection */
        .bike-option {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bike-option:hover, .bike-option.selected {
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.1);
        }

        .bike-option.selected {
            box-shadow: 0 0 20px var(--primary-dim);
        }

        .bike-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bike-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: var(--primary);
        }

        .bike-type {
            font-size: 0.75rem;
            color: var(--text-dim);
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .bike-icon {
            font-size: 3rem;
            text-align: center;
            margin: 15px 0;
        }

        .bike-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }

        .bike-stat-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--secondary);
        }

        .bike-stat-label {
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        /* Footer */
        .game-footer {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .footer-links a {
            color: var(--text-dim);
            text-decoration: none;
            margin-right: 20px;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .footer-credit {
            color: var(--text-dim);
        }

        .footer-credit span {
            color: var(--primary);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Start Screen */
        .start-screen {
            text-align: center;
            padding: 40px;
        }

        .start-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bikeBounce 2s ease-in-out infinite;
        }

        @keyframes bikeBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .start-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
            text-shadow: 0 0 20px var(--primary-dim);
        }

        .start-subtitle {
            font-size: 1.2rem;
            color: var(--text-dim);
            margin-bottom: 30px;
        }

        .start-desc {
            max-width: 500px;
            margin: 0 auto 30px;
            line-height: 1.8;
            color: var(--text-dim);
        }

        .start-btn {
            background: linear-gradient(135deg, var(--primary), #00cc6a);
            border: none;
            color: var(--bg-dark);
            padding: 20px 50px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--primary);
        }

        .start-features {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .start-feature {
            text-align: center;
        }

        .start-feature-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .start-feature-text {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Game Over */
        .game-over {
            text-align: center;
            padding: 40px;
        }

        .game-over-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            color: var(--danger);
            margin-bottom: 20px;
        }

        .game-over-score {
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            color: var(--gold);
            margin: 20px 0;
        }

        .game-over-stats {
            color: var(--text-dim);
            line-height: 2;
            margin-bottom: 30px;
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .game-container {
                grid-template-columns: 1fr;
            }

            .left-panel, .right-panel {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .game-header {
                flex-wrap: wrap;
                gap: 15px;
            }

            .header-stats {
                order: 3;
                width: 100%;
                justify-content: space-around;
            }
        }

        @media (max-width: 600px) {
            .left-panel, .right-panel {
                grid-template-columns: 1fr;
            }

            .header-stats {
                gap: 15px;
            }

            .bike-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .start-title {
                font-size: 1rem;
            }

            .start-features {
                gap: 20px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        /* Sound toggle */
        .sound-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .sound-btn.active {
            color: var(--primary);
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="game-bg"></div>
    
    <div class="game-container" id="game-container">
        <!-- Header -->
        <header class="game-header">
            <div class="game-logo">
                <span class="logo-icon">üö¥‚Äç‚ôÇÔ∏è‚ö°</span>
                <span class="logo-text">TRAIL QUEST</span>
            </div>
            <div class="header-stats" id="header-stats" style="display: none;">
                <div class="header-stat">
                    <div class="header-stat-value" id="stat-score">0</div>
                    <div class="header-stat-label">Score</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="stat-miles">0</div>
                    <div class="header-stat-label">Miles</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="stat-trails">0</div>
                    <div class="header-stat-label">Trails</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="stat-day">1</div>
                    <div class="header-stat-label">Day</div>
                </div>
            </div>
            <div class="header-actions" id="header-actions" style="display: none;">
                <button class="sound-btn" id="sound-btn" onclick="toggleSound()" title="Toggle Sound">üîä</button>
                <button class="header-btn" onclick="saveGame()">üíæ Save</button>
                <button class="header-btn" onclick="showHelp()">‚ùì Help</button>
            </div>
        </header>

        <!-- Main content will be rendered dynamically -->
        <div id="game-content" style="grid-column: 1 / -1; display: contents;">
            <!-- Start screen shown initially -->
        </div>

        <!-- Footer -->
        <footer class="game-footer">
            <div class="footer-links">
                <a href="https://sparkbot207-del.github.io/ne-ebike-pev/" target="_blank">üö¥ NE E-Bike & PEV</a>
                <a href="https://sparkbot207-del.github.io/sparky-command-center/" target="_blank">‚ö° Command Center</a>
            </div>
            <div class="footer-credit">
                Made with <span>‚ö°</span> by Sparky
            </div>
        </footer>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="modal-title">Modal</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Bike Builder System -->
    <script src="js/bike-builder.js"></script>
    <script src="js/garage-ui.js"></script>
    
    <script>
    // ============================================================
    // TRAIL QUEST: NEW ENGLAND E-BIKE ADVENTURE - BUILDER EDITION
    // Created by Sparky ‚ö°
    // Now with real e-bikes, controllers, batteries, and motors!
    // ============================================================

    // ===================
    // GAME CONFIGURATION
    // ===================
    
    const CONFIG = {
        baseUrl: 'https://sparkbot207-del.github.io/ne-ebike-pev',
        saveKey: 'trailquest_save_v2',
        soundEnabled: true
    };

    // ===================
    // GAME DATA
    // ===================

    // E-Bike Options
    const BIKES = [
        {
            id: 'commuter',
            name: 'City Cruiser',
            icon: 'üö≤',
            type: 'Class 1',
            battery: 500,
            range: 45,
            motor: 500,
            speed: 20,
            weight: 45,
            description: 'Lightweight and efficient. Great for paved rail trails.',
            bonuses: { paved: 10, efficiency: 1.2 }
        },
        {
            id: 'mountain',
            name: 'Trail Crusher',
            icon: 'üöµ',
            type: 'Class 1',
            battery: 700,
            range: 35,
            motor: 750,
            speed: 20,
            weight: 55,
            description: 'Full suspension beast. Handles rough terrain like a champ.',
            bonuses: { rough: 15, climbing: 1.3 }
        },
        {
            id: 'fatbike',
            name: 'Fat Explorer',
            icon: 'üõû',
            type: 'Class 2',
            battery: 840,
            range: 30,
            motor: 1000,
            speed: 20,
            weight: 70,
            description: 'Go anywhere. Sand, snow, gravel - no problem.',
            bonuses: { allTerrain: 20, stability: 1.4 }
        },
        {
            id: 'racer',
            name: 'Speed Demon',
            icon: '‚ö°',
            type: 'Class 3',
            battery: 400,
            range: 50,
            motor: 750,
            speed: 28,
            weight: 38,
            description: 'Class 3 road rocket. Fast and furious.',
            bonuses: { speed: 25, paved: 15 }
        },
        {
            id: 'cargo',
            name: 'Pack Mule',
            icon: 'üì¶',
            type: 'Class 2',
            battery: 960,
            range: 40,
            motor: 750,
            speed: 20,
            weight: 80,
            description: 'Extra capacity for gear and supplies.',
            bonuses: { cargo: 4, inventory: 8 }
        }
    ];

    // Inventory Items
    const ITEMS = {
        spare_battery: { name: 'Spare Battery', icon: 'üîã', desc: '+25% battery when used', effect: { battery: 25 }, price: 200, stackable: true },
        energy_bar: { name: 'Energy Bar', icon: 'üç´', desc: '+5% battery, small boost', effect: { battery: 5 }, price: 15, stackable: true },
        repair_kit: { name: 'Repair Kit', icon: 'üîß', desc: 'Fix flat tires and minor issues', effect: { repair: true }, price: 50, stackable: true },
        rain_gear: { name: 'Rain Gear', icon: 'üß•', desc: 'Reduces weather penalties', effect: { weatherResist: 0.5 }, price: 75, equipped: true },
        headlight: { name: 'Headlight', icon: 'üî¶', desc: 'Safe night riding', effect: { nightRiding: true }, price: 40, equipped: true },
        gps: { name: 'GPS Unit', icon: 'üì±', desc: 'Shows charging stations on map', effect: { showChargers: true }, price: 100, equipped: true },
        water_bottle: { name: 'Water Bottle', icon: 'üíß', desc: '+3% battery, stay hydrated', effect: { battery: 3 }, price: 10, stackable: true },
        trail_map: { name: 'Trail Map', icon: 'üó∫Ô∏è', desc: 'Reveals trail details', effect: { trailInfo: true }, price: 25, equipped: true },
        first_aid: { name: 'First Aid Kit', icon: 'ü©π', desc: 'Handle emergencies', effect: { emergency: true }, price: 60, stackable: true },
        snacks: { name: 'Trail Snacks', icon: 'ü•™', desc: '+8% battery, tasty!', effect: { battery: 8 }, price: 20, stackable: true }
    };

    // Achievements
    const ACHIEVEMENTS = [
        { id: 'first_ride', icon: 'üéâ', name: 'First Ride', desc: 'Complete your first trail' },
        { id: 'century', icon: 'üíØ', name: 'Century', desc: 'Ride 100 miles total' },
        { id: 'five_trails', icon: 'üèÜ', name: 'Trail Blazer', desc: 'Complete 5 different trails' },
        { id: 'ten_trails', icon: 'üëë', name: 'Trail Master', desc: 'Complete 10 different trails' },
        { id: 'close_call', icon: 'üò∞', name: 'Close Call', desc: 'Finish a trail under 5% battery' },
        { id: 'perfect', icon: '‚ú®', name: 'Perfect Run', desc: 'Complete a trail with no negative events' },
        { id: 'long_haul', icon: 'üõ§Ô∏è', name: 'Long Hauler', desc: 'Complete a 20+ mile trail' },
        { id: 'speed_run', icon: '‚ö°', name: 'Speed Demon', desc: 'Complete 3 trails in one day' },
        { id: 'explorer', icon: 'üó∫Ô∏è', name: 'Explorer', desc: 'Ride trails in 3 different states' },
        { id: 'all_states', icon: 'üåü', name: 'New England Legend', desc: 'Ride in all 6 NE states' },
        { id: 'shopper', icon: 'üõí', name: 'Shopaholic', desc: 'Buy 10 items from shops' },
        { id: 'collector', icon: 'üéí', name: 'Collector', desc: 'Have 8 items in inventory at once' },
        { id: 'charger_user', icon: 'üîå', name: 'Plugged In', desc: 'Use 5 charging stations' },
        { id: 'survivor', icon: 'ü¶∫', name: 'Survivor', desc: 'Handle 10 negative events' },
        { id: 'wealthy', icon: 'üí∞', name: 'Wealthy Rider', desc: 'Accumulate 1000 points' },
        { id: 'rainy_day', icon: 'üåßÔ∏è', name: 'Rain Rider', desc: 'Complete a trail in the rain' },
        { id: 'night_owl', icon: 'ü¶â', name: 'Night Owl', desc: 'Ride at night' },
        { id: 'helper', icon: 'ü§ù', name: 'Good Samaritan', desc: 'Help another rider 3 times' }
    ];

    // Weather types
    const WEATHER = {
        clear: { icon: '‚òÄÔ∏è', name: 'Clear', effect: 0, desc: 'Perfect riding weather!' },
        partly_cloudy: { icon: '‚õÖ', name: 'Partly Cloudy', effect: 0, desc: 'Nice day for a ride.' },
        cloudy: { icon: '‚òÅÔ∏è', name: 'Cloudy', effect: 0, desc: 'Overcast but fine.' },
        light_rain: { icon: 'üå¶Ô∏è', name: 'Light Rain', effect: -5, desc: 'Slippery trails, -5% battery drain' },
        rain: { icon: 'üåßÔ∏è', name: 'Rain', effect: -10, desc: 'Wet conditions, -10% battery drain' },
        windy: { icon: 'üí®', name: 'Windy', effect: -8, desc: 'Headwinds likely, -8% battery drain' },
        hot: { icon: 'üî•', name: 'Hot', effect: -5, desc: 'Stay hydrated! -5% battery drain' },
        cold: { icon: '‚ùÑÔ∏è', name: 'Cold', effect: -5, desc: 'Bundle up! -5% battery drain' },
        foggy: { icon: 'üå´Ô∏è', name: 'Foggy', effect: -3, desc: 'Low visibility, ride carefully' }
    };

    // Random events
    const EVENTS = {
        positive: [
            { text: 'A fellow rider shares their portable charger!', effect: { battery: 15 }, icon: 'üîã' },
            { text: 'Tailwind! You\'re cruising effortlessly.', effect: { battery: 5 }, icon: 'üí®' },
            { text: 'Beautiful scenic overlook - photo op!', effect: { score: 75 }, icon: 'üì∏' },
            { text: 'Found a shortcut through the woods!', effect: { progress: 0.5 }, icon: 'üó∫Ô∏è' },
            { text: 'Friendly ice cream shop! Quick stop.', effect: { score: 50, battery: 3 }, icon: 'üç¶' },
            { text: 'Regenerative braking on that hill!', effect: { battery: 8 }, icon: '‚ö°' },
            { text: 'Kids think your e-bike is awesome!', effect: { score: 50 }, icon: 'ü§©' },
            { text: 'Free water refill at a park fountain.', effect: { battery: 5 }, icon: '‚õ≤' },
            { text: 'Smooth, freshly paved section!', effect: { battery: 3, score: 25 }, icon: 'üõ£Ô∏è' },
            { text: 'Found a $20 bill on the trail!', effect: { score: 100 }, icon: 'üíµ' }
        ],
        negative: [
            { text: 'Headwind! Working harder than expected.', effect: { battery: -10 }, icon: 'üå¨Ô∏è' },
            { text: 'Unexpected detour - trail construction.', effect: { battery: -8, progress: -0.3 }, icon: 'üöß' },
            { text: 'Sandy patch - had to power through.', effect: { battery: -12 }, icon: 'üèñÔ∏è' },
            { text: 'Curious deer blocks the trail.', effect: { battery: -3 }, icon: 'ü¶å' },
            { text: 'Hill was steeper than expected!', effect: { battery: -15 }, icon: '‚õ∞Ô∏è' },
            { text: 'Stopped to help someone with a flat.', effect: { battery: -5, score: 100 }, icon: 'üõ†Ô∏è', helper: true },
            { text: 'Muddy section after yesterday\'s rain.', effect: { battery: -10 }, icon: 'üí¶' },
            { text: 'Wrong turn, had to backtrack.', effect: { battery: -7, progress: -0.2 }, icon: '‚Ü©Ô∏è' },
            { text: 'Bridge closed - longer route needed.', effect: { battery: -12 }, icon: 'üåâ' },
            { text: 'Phone battery died - no GPS!', effect: { battery: -5 }, icon: 'üìµ' }
        ],
        neutral: [
            { text: 'Crossed into a new state!', icon: 'ü™ß' },
            { text: 'A hawk circles overhead. Nature!', icon: 'ü¶Ö' },
            { text: 'Waved at a passing train.', icon: 'üöÇ' },
            { text: 'Historical marker - old railroad line.', icon: 'üìú' },
            { text: 'Turtle crossing the trail. Careful!', icon: 'üê¢' },
            { text: 'Beautiful wildflowers along the path.', icon: 'üå∏' },
            { text: 'Other e-bikers wave hello!', icon: 'üëã' },
            { text: 'Old train station, now a rest stop.', icon: 'üöâ' },
            { text: 'Crossed a covered bridge!', icon: 'üåâ' },
            { text: 'Spotted a family of ducks.', icon: 'ü¶Ü' }
        ],
        special: [
            { text: 'RARE: Found an abandoned spare battery!', effect: { item: 'spare_battery' }, icon: 'üéÅ' },
            { text: 'RARE: Trail angel gives you snacks!', effect: { item: 'snacks', item_count: 2 }, icon: 'üòá' },
            { text: 'JACKPOT: Hidden geocache with goodies!', effect: { score: 200, item: 'energy_bar', item_count: 3 }, icon: 'üì¶' }
        ]
    };

    // Shops (real NE e-bike shops!)
    const SHOPS = [
        {
            id: 'radmoto',
            name: 'Radmoto USA',
            location: 'Portsmouth, NH',
            icon: 'üè™',
            featured: true,
            inventory: ['spare_battery', 'repair_kit', 'headlight', 'gps', 'rain_gear'],
            discount: 0.1,
            description: 'Premier e-bike dealer with expert service'
        },
        {
            id: 'kings_mountain',
            name: "King's Mountain RC",
            location: 'Brewer, ME',
            icon: 'üèîÔ∏è',
            inventory: ['energy_bar', 'water_bottle', 'snacks', 'repair_kit', 'first_aid'],
            description: 'Local shop with great trail knowledge'
        },
        {
            id: 'trail_stop',
            name: 'Trail Stop General',
            location: 'Various Trailheads',
            icon: 'üèïÔ∏è',
            inventory: ['energy_bar', 'water_bottle', 'snacks', 'trail_map'],
            description: 'Basic supplies at trailheads'
        }
    ];

    // Real trail data (loaded from API)
    let TRAILS = [];

    // ===================
    // GAME STATE
    // ===================

    let game = {
        screen: 'start',
        bike: null,
        battery: 100,
        maxBattery: 100,
        score: 0,
        money: 0, // Cash for upgrades
        totalMiles: 0,
        day: 1,
        time: 8, // 8 AM
        weather: null,
        currentTrail: null,
        trailProgress: 0,
        inventory: [],
        maxInventory: 6,
        equipped: [],
        completedTrails: [],
        achievements: [],
        stats: {
            trailsCompleted: 0,
            totalEvents: 0,
            negativeEvents: 0,
            helpedRiders: 0,
            itemsBought: 0,
            chargersUsed: 0,
            statesVisited: []
        },
        currentShop: null,
        eventsThisTrail: [],
        dayTrailsCompleted: 0,
        soundEnabled: true,
        // Bike Builder additions
        currentBuild: null,
        buildLog: [],
        selectedPackage: null,
        shopType: null
    };

    // ===================
    // INITIALIZATION
    // ===================

    async function init() {
        await loadTrailData();
        checkForSavedGame();
        generateWeather();
        render();
    }

    async function loadTrailData() {
        try {
            const response = await fetch(`${CONFIG.baseUrl}/data/rail_trails.json`);
            const data = await response.json();
            TRAILS = data.filter(t => t.length && t.length > 2).map(t => ({
                ...t,
                difficulty: t.length > 20 ? 'hard' : t.length > 10 ? 'moderate' : 'easy',
                surface: t.surface || 'Mixed'
            }));
            console.log(`Loaded ${TRAILS.length} trails!`);
        } catch (e) {
            console.log('Using fallback trail data');
            TRAILS = getFallbackTrails();
        }
    }

    function getFallbackTrails() {
        return [
            { name: "East Bay Bike Path", state: "Rhode Island", length: 14.5, surface: "Paved", rating: 4.7, difficulty: 'moderate', description: "Scenic coastal trail from Providence to Bristol" },
            { name: "Minuteman Bikeway", state: "Massachusetts", length: 11, surface: "Paved", rating: 4.8, difficulty: 'moderate', description: "Historic path through Lexington and Concord" },
            { name: "Cape Cod Rail Trail", state: "Massachusetts", length: 25.8, surface: "Paved", rating: 4.6, difficulty: 'hard', description: "Classic Cape ride through pine forests" },
            { name: "Burlington Bike Path", state: "Vermont", length: 12.6, surface: "Paved", rating: 4.9, difficulty: 'moderate', description: "Stunning Lake Champlain waterfront" },
            { name: "Eastern Trail", state: "Maine", length: 28.5, surface: "Mixed", rating: 4.5, difficulty: 'hard', description: "Coastal Maine beauty" },
            { name: "Airline State Park Trail", state: "Connecticut", length: 50, surface: "Crushed Stone", rating: 4.4, difficulty: 'hard', description: "Epic cross-state adventure" },
            { name: "Ashuelot Rail Trail", state: "New Hampshire", length: 21.2, surface: "Crushed Stone", rating: 4.3, difficulty: 'hard', description: "Rural New Hampshire scenery" },
            { name: "Blackstone River Bikeway", state: "Rhode Island", length: 18, surface: "Paved", rating: 4.4, difficulty: 'moderate', description: "Industrial heritage meets nature" }
        ];
    }

    // ===================
    // RENDERING
    // ===================

    function render() {
        const content = document.getElementById('game-content');
        const headerStats = document.getElementById('header-stats');
        const headerActions = document.getElementById('header-actions');

        // Show/hide header elements based on screen
        const showUI = !['start', 'select_bike'].includes(game.screen);
        headerStats.style.display = showUI ? 'flex' : 'none';
        headerActions.style.display = showUI ? 'flex' : 'none';

        // Update header stats
        if (showUI) {
            document.getElementById('stat-score').textContent = game.score;
            document.getElementById('stat-miles').textContent = game.totalMiles.toFixed(1);
            document.getElementById('stat-trails').textContent = game.stats.trailsCompleted;
            document.getElementById('stat-day').textContent = game.day;
        }

        // Render screen
        switch (game.screen) {
            case 'start': content.innerHTML = renderStartScreen(); break;
            case 'select_bike': content.innerHTML = renderBikeSelect(); break;
            case 'starter_select': content.innerHTML = renderStarterSelect(); break;
            case 'garage': content.innerHTML = renderGarage(); break;
            case 'component_shop': content.innerHTML = renderComponentShop(game.shopType); break;
            case 'hub': content.innerHTML = renderHub(); break;
            case 'riding': content.innerHTML = renderRiding(); break;
            case 'event': content.innerHTML = renderEvent(); break;
            case 'trail_complete': content.innerHTML = renderTrailComplete(); break;
            case 'shop': content.innerHTML = renderShop(); break;
            case 'charging': content.innerHTML = renderCharging(); break;
            case 'gameover': content.innerHTML = renderGameOver(); break;
        }
    }

    function renderStartScreen() {
        return `
            <div class="main-screen" style="grid-column: 1 / -1;">
                <div class="game-screen">
                    <div class="start-screen">
                        <div class="start-logo">üö¥‚Äç‚ôÇÔ∏è‚ö°</div>
                        <h1 class="start-title">TRAIL QUEST</h1>
                        <p class="start-subtitle">New England E-Bike Adventure</p>
                        <p class="start-desc">
                            Build your dream e-bike with <span class="highlight">real parts</span>! 
                            Start with a Super 73, ONYX, Sur-Ron, or Revv1. Upgrade with 
                            Fardriver controllers, QS205 motors, and Chi batteries. 
                            Ride hundreds of miles of New England rail trails!
                        </p>
                        <button class="start-btn" onclick="startNewGame()">üîß BUILD & RIDE</button>
                        ${hasSavedGame() ? `
                            <button class="start-btn" style="background: var(--secondary); margin-left: 15px;" onclick="loadGame()">
                                üìÇ CONTINUE
                            </button>
                        ` : ''}
                        <div class="start-features">
                            <div class="start-feature">
                                <div class="start-feature-icon">üèçÔ∏è</div>
                                <div class="start-feature-text">Real E-Bikes</div>
                            </div>
                            <div class="start-feature">
                                <div class="start-feature-icon">üéõÔ∏è</div>
                                <div class="start-feature-text">Fardriver & More</div>
                            </div>
                            <div class="start-feature">
                                <div class="start-feature-icon">‚öôÔ∏è</div>
                                <div class="start-feature-text">QS205 Motors</div>
                            </div>
                            <div class="start-feature">
                                <div class="start-feature-icon">üîã</div>
                                <div class="start-feature-text">72V-96V Builds</div>
                            </div>
                        </div>
                        <div class="start-features" style="margin-top: 15px;">
                            <div class="start-feature">
                                <div class="start-feature-icon">üó∫Ô∏è</div>
                                <div class="start-feature-text">${TRAILS.length}+ Real Trails</div>
                            </div>
                            <div class="start-feature">
                                <div class="start-feature-icon">üå¶Ô∏è</div>
                                <div class="start-feature-text">Dynamic Weather</div>
                            </div>
                            <div class="start-feature">
                                <div class="start-feature-icon">üèÜ</div>
                                <div class="start-feature-text">${ACHIEVEMENTS.length} Achievements</div>
                            </div>
                            <div class="start-feature">
                                <div class="start-feature-icon">üí∞</div>
                                <div class="start-feature-text">Earn & Upgrade</div>
                            </div>
                        </div>
                        <p style="margin-top: 30px; color: var(--text-dim); font-size: 0.9rem;">
                            Featuring real trail data from <a href="${CONFIG.baseUrl}" target="_blank" style="color: var(--primary);">NE E-Bike & PEV</a>
                        </p>
                    </div>
                </div>
            </div>
        `;
    }

    function renderBikeSelect() {
        const bikesHtml = BIKES.map(bike => `
            <div class="bike-option ${game.bike?.id === bike.id ? 'selected' : ''}" onclick="selectBike('${bike.id}')">
                <div class="bike-header">
                    <span class="bike-name">${bike.name}</span>
                    <span class="bike-type">${bike.type}</span>
                </div>
                <div class="bike-icon">${bike.icon}</div>
                <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 15px;">${bike.description}</p>
                <div class="bike-stats">
                    <div>
                        <div class="bike-stat-value">${bike.battery}Wh</div>
                        <div class="bike-stat-label">Battery</div>
                    </div>
                    <div>
                        <div class="bike-stat-value">~${bike.range}mi</div>
                        <div class="bike-stat-label">Range</div>
                    </div>
                    <div>
                        <div class="bike-stat-value">${bike.motor}W</div>
                        <div class="bike-stat-label">Motor</div>
                    </div>
                    <div>
                        <div class="bike-stat-value">${bike.speed}mph</div>
                        <div class="bike-stat-label">Max Speed</div>
                    </div>
                </div>
            </div>
        `).join('');

        return `
            <div class="main-screen" style="grid-column: 1 / -1;">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">‚ö° CHOOSE YOUR RIDE</span>
                    </div>
                    <div class="screen-content">
                        <p class="narrative">Each e-bike has unique strengths. Choose wisely - it'll affect your entire adventure!</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
                            ${bikesHtml}
                        </div>
                        <div class="choices" style="margin-top: 30px;">
                            <button class="choice-btn" onclick="confirmBike()" ${!game.bike ? 'disabled' : ''}>
                                ‚úÖ LET'S RIDE!
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderHub() {
        // Get available trails
        const availableTrails = TRAILS
            .filter(t => !game.completedTrails.includes(t.name))
            .sort(() => Math.random() - 0.5)
            .slice(0, 5);

        const trailsHtml = availableTrails.map(trail => {
            const batteryCost = calculateBatteryCost(trail);
            const canAfford = game.battery >= batteryCost * 0.4;
            const ratingStars = '‚≠ê'.repeat(Math.round(trail.rating || 4));
            
            return `
                <div class="trail-card" style="${!canAfford ? 'opacity: 0.5;' : ''}">
                    <div class="trail-card-header">
                        <span class="trail-name">${trail.name}</span>
                        <span class="trail-difficulty ${trail.difficulty}">${trail.difficulty}</span>
                    </div>
                    <div class="trail-stats">
                        <span>üìç ${trail.state}</span>
                        <span>üìè ${trail.length} mi</span>
                        <span>üõ§Ô∏è ${trail.surface}</span>
                        <span class="trail-rating">${ratingStars}</span>
                    </div>
                    <p class="trail-desc">${trail.description || 'A beautiful New England trail'}</p>
                    <button class="choice-btn" style="margin-top: 10px;" onclick="startTrail('${trail.name}')" ${!canAfford ? 'disabled' : ''}>
                        üö¥ Ride This Trail
                        <span class="choice-cost">~${batteryCost}% battery</span>
                    </button>
                </div>
            `;
        }).join('');

        return `
            <div class="left-panel">
                ${renderBatteryPanel()}
                ${renderInventoryPanel()}
                ${renderWeatherPanel()}
            </div>

            <div class="main-screen">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">üó∫Ô∏è TRAIL HUB - DAY ${game.day}</span>
                        <span class="screen-subtitle">${getTimeString()} ${game.weather.icon}</span>
                    </div>
                    <div class="screen-content">
                        ${game.battery < 30 ? `
                            <div class="event-box warning">
                                <div class="event-title">‚ö†Ô∏è LOW BATTERY WARNING</div>
                                <p>Your battery is getting low! Consider charging before your next trail.</p>
                            </div>
                        ` : ''}
                        
                        <h3 style="color: var(--primary); margin-bottom: 15px; font-family: 'Press Start 2P', cursive; font-size: 0.7rem;">
                            AVAILABLE TRAILS
                        </h3>
                        ${trailsHtml}
                        
                        <div class="choices" style="margin-top: 25px;">
                            ${game.currentBuild ? `
                                <button class="choice-btn" onclick="goToGarage()">
                                    üîß Your Garage
                                    <span class="choice-cost">Upgrade your build ‚Ä¢ $${(game.money || 0).toLocaleString()}</span>
                                </button>
                            ` : ''}
                            <button class="choice-btn secondary" onclick="goToShop()">
                                üè™ Visit Shop
                                <span class="choice-cost">Buy gear & supplies</span>
                            </button>
                            <button class="choice-btn secondary" onclick="findCharging()">
                                üîå Find Charging Station
                                <span class="choice-cost">Recharge your battery</span>
                            </button>
                            <button class="choice-btn warning" onclick="endDay()">
                                üåô End Day & Rest
                                <span class="choice-cost">Start fresh tomorrow</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                ${renderStatsPanel()}
                ${renderAchievementsPanel()}
            </div>
        `;
    }

    function renderRiding() {
        const trail = game.currentTrail;
        const progress = game.trailProgress;
        const progressPct = (progress / trail.length) * 100;
        const remaining = trail.length - progress;

        return `
            <div class="left-panel">
                ${renderBatteryPanel()}
                ${renderInventoryPanel()}
                ${renderWeatherPanel()}
            </div>

            <div class="main-screen">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">üö¥ ${trail.name}</span>
                        <span class="screen-subtitle">${trail.state} ‚Ä¢ ${trail.surface}</span>
                    </div>
                    <div class="screen-content">
                        <div class="progress-container">
                            <div class="progress-label">
                                <span><span class="highlight">${progress.toFixed(1)}</span> miles complete</span>
                                <span><span class="highlight">${remaining.toFixed(1)}</span> miles to go</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPct}%"></div>
                            </div>
                        </div>

                        ${renderMiniMap(progressPct)}

                        <div class="narrative" style="margin-top: 20px;">
                            <p>${getTrailNarrative(trail, progress)}</p>
                        </div>

                        <div class="choices">
                            <button class="choice-btn" onclick="rideSegment('eco')">
                                üå± Eco Mode
                                <span class="choice-cost">+${getSegmentDistance('eco')}mi / -${getSegmentCost('eco')}% battery</span>
                            </button>
                            <button class="choice-btn" onclick="rideSegment('normal')">
                                üö¥ Normal Mode
                                <span class="choice-cost">+${getSegmentDistance('normal')}mi / -${getSegmentCost('normal')}% battery</span>
                            </button>
                            <button class="choice-btn" onclick="rideSegment('sport')">
                                ‚ö° Sport Mode
                                <span class="choice-cost">+${getSegmentDistance('sport')}mi / -${getSegmentCost('sport')}% battery</span>
                            </button>
                            <button class="choice-btn" onclick="rideSegment('turbo')">
                                üöÄ Turbo Mode
                                <span class="choice-cost">+${getSegmentDistance('turbo')}mi / -${getSegmentCost('turbo')}% battery</span>
                            </button>
                            ${progress > 0 ? `
                                <button class="choice-btn danger" onclick="abandonTrail()">
                                    üè≥Ô∏è Turn Back
                                    <span class="choice-cost">Keep miles, find safety</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                ${renderStatsPanel()}
                ${renderAchievementsPanel()}
            </div>
        `;
    }

    function renderEvent() {
        const event = game.currentEvent;
        const boxClass = event.effect?.battery < 0 ? 'warning' : 
                        event.effect?.item ? 'gold' : '';
        
        return `
            <div class="left-panel">
                ${renderBatteryPanel()}
                ${renderInventoryPanel()}
                ${renderWeatherPanel()}
            </div>

            <div class="main-screen">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">${event.icon} TRAIL EVENT</span>
                    </div>
                    <div class="screen-content">
                        <div class="event-box ${boxClass}" style="font-size: 1.2rem; padding: 25px;">
                            <p>${event.text}</p>
                            ${event.effect ? `
                                <p style="margin-top: 15px; font-size: 1rem;">
                                    ${event.effect.battery ? `<span style="color: ${event.effect.battery > 0 ? 'var(--primary)' : 'var(--warning)'}">
                                        ${event.effect.battery > 0 ? '+' : ''}${event.effect.battery}% battery
                                    </span>` : ''}
                                    ${event.effect.score ? `<span style="color: var(--gold)"> +${event.effect.score} points</span>` : ''}
                                    ${event.effect.item ? `<span style="color: var(--gold)"> +${ITEMS[event.effect.item]?.name || event.effect.item}</span>` : ''}
                                </p>
                            ` : ''}
                        </div>
                        <div class="choices">
                            <button class="choice-btn" onclick="continueFromEvent()">
                                ‚û°Ô∏è Continue Riding
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                ${renderStatsPanel()}
                ${renderAchievementsPanel()}
            </div>
        `;
    }

    function renderTrailComplete() {
        const trail = game.currentTrail;
        const bonusPoints = calculateTrailBonus(trail);
        
        return `
            <div class="left-panel">
                ${renderBatteryPanel()}
                ${renderInventoryPanel()}
                ${renderWeatherPanel()}
            </div>

            <div class="main-screen">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">üéâ TRAIL COMPLETE!</span>
                    </div>
                    <div class="screen-content" style="text-align: center;">
                        <div class="event-box gold" style="text-align: center;">
                            <h2 style="color: var(--gold); margin-bottom: 15px;">${trail.name}</h2>
                            <div style="font-size: 3rem; margin: 20px 0;">üèÜ</div>
                            <div style="display: grid; grid-template-columns: repeat(${game.moneyEarned ? '4' : '3'}, 1fr); gap: 20px; margin: 20px 0;">
                                <div>
                                    <div style="font-family: 'Press Start 2P', cursive; font-size: 1rem; color: var(--primary);">
                                        ${trail.length}
                                    </div>
                                    <div style="color: var(--text-dim); font-size: 0.85rem;">Miles</div>
                                </div>
                                <div>
                                    <div style="font-family: 'Press Start 2P', cursive; font-size: 1rem; color: var(--gold);">
                                        +${bonusPoints}
                                    </div>
                                    <div style="color: var(--text-dim); font-size: 0.85rem;">Points</div>
                                </div>
                                ${game.moneyEarned ? `
                                <div>
                                    <div style="font-family: 'Press Start 2P', cursive; font-size: 1rem; color: var(--gold);">
                                        +$${game.moneyEarned}
                                    </div>
                                    <div style="color: var(--text-dim); font-size: 0.85rem;">Cash</div>
                                </div>
                                ` : ''}
                                <div>
                                    <div style="font-family: 'Press Start 2P', cursive; font-size: 1rem; color: var(--secondary);">
                                        ${Math.round(game.battery)}%
                                    </div>
                                    <div style="color: var(--text-dim); font-size: 0.85rem;">Battery Left</div>
                                </div>
                            </div>
                        </div>
                        
                        ${game.newAchievements?.length ? `
                            <div class="event-box" style="margin-top: 20px;">
                                <div class="event-title">üèÜ NEW ACHIEVEMENTS!</div>
                                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 10px;">
                                    ${game.newAchievements.map(a => `
                                        <div style="text-align: center;">
                                            <div style="font-size: 2rem;">${a.icon}</div>
                                            <div style="font-size: 0.8rem; color: var(--gold);">${a.name}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="choices" style="margin-top: 30px;">
                            <button class="choice-btn" onclick="backToHub()">
                                üó∫Ô∏è Back to Trail Hub
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                ${renderStatsPanel()}
                ${renderAchievementsPanel()}
            </div>
        `;
    }

    function renderShop() {
        const shop = SHOPS[0]; // Default to first shop for now
        
        const itemsHtml = shop.inventory.map(itemId => {
            const item = ITEMS[itemId];
            if (!item) return '';
            const price = shop.discount ? Math.floor(item.price * (1 - shop.discount)) : item.price;
            const canAfford = game.score >= price;
            const owned = item.equipped && game.equipped.includes(itemId);
            
            return `
                <div class="shop-item ${owned ? 'owned' : ''}" onclick="${owned ? '' : `buyItem('${itemId}', ${price})`}">
                    <div class="shop-item-icon">${item.icon}</div>
                    <div class="shop-item-info">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-desc">${item.desc}</div>
                    </div>
                    <div class="shop-item-price">${owned ? '‚úì OWNED' : `${price} pts`}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="left-panel">
                ${renderBatteryPanel()}
                ${renderInventoryPanel()}
                ${renderWeatherPanel()}
            </div>

            <div class="main-screen">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">${shop.icon} ${shop.name}</span>
                        <span class="screen-subtitle">${shop.location}</span>
                    </div>
                    <div class="screen-content">
                        <p class="narrative">${shop.description}</p>
                        ${shop.featured ? `
                            <div class="event-box gold">
                                <div class="event-title">‚≠ê FEATURED PARTNER</div>
                                <p>10% discount on all items!</p>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 20px;">
                            <p style="color: var(--gold); margin-bottom: 15px; font-family: 'Press Start 2P', cursive; font-size: 0.6rem;">
                                YOUR POINTS: ${game.score}
                            </p>
                            ${itemsHtml}
                        </div>

                        <div class="choices" style="margin-top: 25px;">
                            <button class="choice-btn" onclick="backToHub()">
                                ‚¨ÖÔ∏è Leave Shop
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                ${renderStatsPanel()}
                ${renderAchievementsPanel()}
            </div>
        `;
    }

    function renderCharging() {
        const chargeNeeded = 100 - game.battery;
        
        return `
            <div class="left-panel">
                ${renderBatteryPanel()}
                ${renderInventoryPanel()}
                ${renderWeatherPanel()}
            </div>

            <div class="main-screen">
                <div class="game-screen">
                    <div class="screen-header">
                        <span class="screen-title">üîå CHARGING STATION</span>
                    </div>
                    <div class="screen-content">
                        <div class="event-box">
                            <p style="font-size: 1.1rem;">You found a Level 2 charging station! Current battery: <span class="highlight">${Math.round(game.battery)}%</span></p>
                        </div>
                        
                        <div class="choices" style="margin-top: 20px;">
                            <button class="choice-btn" onclick="charge(30)" ${game.battery >= 100 ? 'disabled' : ''}>
                                ‚ö° Quick Charge (30 min)
                                <span class="choice-cost">+${Math.min(40, chargeNeeded)}% battery</span>
                            </button>
                            <button class="choice-btn" onclick="charge(60)" ${game.battery >= 100 ? 'disabled' : ''}>
                                ‚ö° Standard Charge (1 hr)
                                <span class="choice-cost">+${Math.min(70, chargeNeeded)}% battery</span>
                            </button>
                            <button class="choice-btn" onclick="charge(120)" ${game.battery >= 100 ? 'disabled' : ''}>
                                ‚ö° Full Charge (2 hrs)
                                <span class="choice-cost">+${chargeNeeded}% battery</span>
                            </button>
                            <button class="choice-btn secondary" onclick="backToHub()">
                                ‚¨ÖÔ∏è Skip, Back to Trails
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                ${renderStatsPanel()}
                ${renderAchievementsPanel()}
            </div>
        `;
    }

    function renderGameOver() {
        const grade = game.score >= 2000 ? 'S' :
                     game.score >= 1500 ? 'A' :
                     game.score >= 1000 ? 'B' :
                     game.score >= 500 ? 'C' : 'D';

        return `
            <div class="main-screen" style="grid-column: 1 / -1;">
                <div class="game-screen">
                    <div class="game-over">
                        <h1 class="game-over-title">üîã BATTERY DEPLETED!</h1>
                        <p style="color: var(--text-dim); margin: 20px 0;">
                            You're stranded! Should've watched that battery gauge...
                        </p>
                        <div class="game-over-score">
                            ${game.score} POINTS
                            <div style="font-size: 1rem; margin-top: 10px;">Grade: ${grade}</div>
                        </div>
                        <div class="game-over-stats">
                            üìè ${game.totalMiles.toFixed(1)} miles ridden<br>
                            üõ§Ô∏è ${game.stats.trailsCompleted} trails completed<br>
                            üìÖ ${game.day} days adventuring<br>
                            üîå ${game.stats.chargersUsed} charging stops<br>
                            üèÜ ${game.achievements.length} achievements
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px;">
                            ${game.achievements.map(a => `<span style="font-size: 2rem;">${a.icon}</span>`).join('')}
                        </div>
                        <button class="start-btn" onclick="startNewGame()">üîÑ PLAY AGAIN</button>
                    </div>
                </div>
            </div>
        `;
    }

    // ===================
    // PANEL RENDERERS
    // ===================

    function renderBatteryPanel() {
        const batteryClass = game.battery < 20 ? 'danger' : game.battery < 40 ? 'warning' : '';
        return `
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üîã Battery</span>
                    <span style="color: var(--text-dim);">${game.bike?.name || ''}</span>
                </div>
                <div class="battery-display">
                    <div class="battery-bar-outer">
                        <div class="battery-bar-fill ${batteryClass}" style="width: ${game.battery}%"></div>
                        <span class="battery-text">${Math.round(game.battery)}%</span>
                    </div>
                    <div class="battery-info">
                        <span>~${Math.round(game.battery * (game.bike?.range || 40) / 100)} mi range</span>
                        <span>${game.bike?.battery || 500}Wh</span>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${game.bike?.motor || 500}W</div>
                        <div class="stat-label">Motor</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${game.bike?.speed || 20}mph</div>
                        <div class="stat-label">Max Speed</div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderInventoryPanel() {
        const slots = [];
        for (let i = 0; i < game.maxInventory; i++) {
            const item = game.inventory[i];
            if (item) {
                const itemData = ITEMS[item.id];
                slots.push(`
                    <div class="inventory-slot" onclick="useItem(${i})" title="${itemData?.name}: ${itemData?.desc}">
                        ${itemData?.icon || '?'}
                        ${item.count > 1 ? `<span class="item-count">${item.count}</span>` : ''}
                    </div>
                `);
            } else {
                slots.push(`<div class="inventory-slot empty">-</div>`);
            }
        }

        return `
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üéí Inventory</span>
                    <span style="color: var(--text-dim);">${game.inventory.length}/${game.maxInventory}</span>
                </div>
                <div class="inventory-grid">
                    ${slots.join('')}
                </div>
                ${game.equipped.length > 0 ? `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                        <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 5px;">EQUIPPED:</div>
                        <div style="display: flex; gap: 5px;">
                            ${game.equipped.map(id => `<span title="${ITEMS[id]?.name}">${ITEMS[id]?.icon}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }

    function renderWeatherPanel() {
        const w = game.weather;
        return `
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üå§Ô∏è Weather</span>
                </div>
                <div class="weather-display">
                    <div class="weather-icon">${w.icon}</div>
                    <div class="weather-info">
                        <div class="weather-temp">${w.name}</div>
                        <div class="weather-desc">${w.desc}</div>
                        ${w.effect !== 0 ? `
                            <div class="weather-effect">
                                ${w.effect > 0 ? '+' : ''}${w.effect}% battery per segment
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    function renderStatsPanel() {
        return `
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üìä Stats</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${game.totalMiles.toFixed(1)}</div>
                        <div class="stat-label">Total Miles</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${game.stats.trailsCompleted}</div>
                        <div class="stat-label">Trails Done</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${game.stats.statesVisited.length}</div>
                        <div class="stat-label">States</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${game.stats.chargersUsed}</div>
                        <div class="stat-label">Charges</div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderAchievementsPanel() {
        const achievementsHtml = ACHIEVEMENTS.slice(0, 9).map(a => {
            const unlocked = game.achievements.some(ua => ua.id === a.id);
            return `
                <div class="achievement ${unlocked ? 'unlocked' : 'locked'}">
                    ${a.icon}
                    <div class="achievement-tooltip">${a.name}: ${a.desc}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üèÜ Achievements</span>
                    <span style="color: var(--gold);">${game.achievements.length}/${ACHIEVEMENTS.length}</span>
                </div>
                <div class="achievements-grid">
                    ${achievementsHtml}
                </div>
            </div>
        `;
    }

    function renderMiniMap(progressPct) {
        return `
            <div class="mini-map">
                <div class="mini-map-trail"></div>
                <div class="mini-map-progress" style="width: ${progressPct * 0.8}%"></div>
                <div class="mini-map-start">üö©</div>
                <div class="mini-map-rider" style="left: ${10 + progressPct * 0.8}%">üö¥</div>
                <div class="mini-map-end">üèÅ</div>
                <div class="mini-map-label">${game.currentTrail.name}</div>
            </div>
        `;
    }

    // ===================
    // GAME LOGIC
    // ===================

    function startNewGame() {
        game = {
            screen: 'starter_select', // Go to starter package selection
            bike: null,
            battery: 100,
            maxBattery: 100,
            score: 0,
            money: 0,
            totalMiles: 0,
            day: 1,
            time: 8,
            weather: null,
            currentTrail: null,
            trailProgress: 0,
            inventory: [],
            maxInventory: 6,
            equipped: [],
            completedTrails: [],
            achievements: [],
            stats: {
                trailsCompleted: 0,
                totalEvents: 0,
                negativeEvents: 0,
                helpedRiders: 0,
                itemsBought: 0,
                chargersUsed: 0,
                statesVisited: []
            },
            currentShop: null,
            eventsThisTrail: [],
            dayTrailsCompleted: 0,
            soundEnabled: true,
            currentBuild: null,
            buildLog: [],
            selectedPackage: null,
            shopType: null
        };
        generateWeather();
        render();
    }
    
    // Legacy bike selection for compatibility
    function startClassicMode() {
        game.screen = 'select_bike';
        render();
    }

    function selectBike(bikeId) {
        game.bike = BIKES.find(b => b.id === bikeId);
        if (game.bike.bonuses?.inventory) {
            game.maxInventory = game.bike.bonuses.inventory;
        }
        playSound('select');
        render();
    }

    function confirmBike() {
        if (!game.bike) return;
        game.screen = 'hub';
        playSound('start');
        saveGame();
        render();
    }

    function startTrail(trailName) {
        game.currentTrail = TRAILS.find(t => t.name === trailName);
        game.trailProgress = 0;
        game.eventsThisTrail = [];
        game.screen = 'riding';
        
        // Track state visit
        if (!game.stats.statesVisited.includes(game.currentTrail.state)) {
            game.stats.statesVisited.push(game.currentTrail.state);
        }
        
        playSound('start');
        render();
    }

    function rideSegment(mode) {
        const distance = getSegmentDistance(mode);
        const cost = getSegmentCost(mode);
        
        game.trailProgress += distance;
        game.totalMiles += distance;
        game.battery -= cost;
        game.time += 0.5; // 30 minutes per segment
        
        playSound('ride');
        
        // Check for events (35% chance)
        if (Math.random() < 0.35) {
            triggerEvent();
            return;
        }
        
        // Check if trail complete
        if (game.trailProgress >= game.currentTrail.length) {
            completeTrail();
            return;
        }
        
        // Check if out of battery
        if (game.battery <= 0) {
            game.battery = 0;
            game.screen = 'gameover';
            playSound('gameover');
            render();
            return;
        }
        
        render();
    }

    function getSegmentDistance(mode) {
        const base = { eco: 1.5, normal: 2.5, sport: 4, turbo: 6 };
        return base[mode] || 2.5;
    }

    function getSegmentCost(mode) {
        const base = { eco: 2, normal: 5, sport: 10, turbo: 18 };
        let cost = base[mode] || 5;
        
        // Apply weather effect
        if (game.weather?.effect) {
            cost += Math.abs(game.weather.effect) * 0.3;
        }
        
        // Apply bike efficiency
        if (game.bike?.bonuses?.efficiency) {
            cost /= game.bike.bonuses.efficiency;
        }
        
        // Apply equipped items
        if (game.equipped.includes('rain_gear') && game.weather?.effect < 0) {
            cost *= 0.7;
        }
        
        return Math.round(cost);
    }

    function calculateBatteryCost(trail) {
        const baseCost = (trail.length / (game.bike?.range || 40)) * 100;
        const difficultyMult = { easy: 0.9, moderate: 1, hard: 1.2 };
        return Math.round(baseCost * (difficultyMult[trail.difficulty] || 1));
    }

    function calculateTrailBonus(trail) {
        const basePoints = Math.round(trail.length * 10);
        const ratingBonus = Math.round((trail.rating || 4) * 20);
        const difficultyBonus = { easy: 0, moderate: 50, hard: 100 };
        return basePoints + ratingBonus + (difficultyBonus[trail.difficulty] || 0);
    }

    function triggerEvent() {
        game.stats.totalEvents++;
        
        // Determine event type
        const roll = Math.random();
        let eventPool;
        
        if (roll < 0.05) { // 5% special
            eventPool = EVENTS.special;
        } else if (roll < 0.35) { // 30% positive
            eventPool = EVENTS.positive;
        } else if (roll < 0.65) { // 30% negative
            eventPool = EVENTS.negative;
            game.stats.negativeEvents++;
        } else { // 35% neutral
            eventPool = EVENTS.neutral;
        }
        
        game.currentEvent = eventPool[Math.floor(Math.random() * eventPool.length)];
        game.eventsThisTrail.push(game.currentEvent);
        game.screen = 'event';
        
        playSound(game.currentEvent.effect?.battery < 0 ? 'negative' : 'positive');
        render();
    }

    function continueFromEvent() {
        const event = game.currentEvent;
        
        if (event.effect) {
            if (event.effect.battery) {
                game.battery = Math.min(100, Math.max(0, game.battery + event.effect.battery));
            }
            if (event.effect.score) {
                game.score += event.effect.score;
            }
            if (event.effect.progress) {
                game.trailProgress += game.currentTrail.length * event.effect.progress;
            }
            if (event.effect.item) {
                addToInventory(event.effect.item, event.effect.item_count || 1);
            }
            if (event.helper) {
                game.stats.helpedRiders++;
            }
        }
        
        // Check if out of battery
        if (game.battery <= 0) {
            game.battery = 0;
            game.screen = 'gameover';
            playSound('gameover');
            render();
            return;
        }
        
        // Check if trail complete
        if (game.trailProgress >= game.currentTrail.length) {
            completeTrail();
            return;
        }
        
        game.screen = 'riding';
        render();
    }

    function completeTrail() {
        const trail = game.currentTrail;
        
        game.stats.trailsCompleted++;
        game.completedTrails.push(trail.name);
        game.dayTrailsCompleted++;
        
        // Award points
        const bonus = calculateTrailBonus(trail);
        game.score += bonus;
        
        // Award money (for bike builder mode)
        if (typeof awardTrailMoney === 'function') {
            game.moneyEarned = awardTrailMoney(trail);
        }
        
        // Check achievements (also awards money)
        game.newAchievements = checkAchievements();
        
        game.screen = 'trail_complete';
        playSound('complete');
        saveGame();
        render();
    }

    function checkAchievements() {
        const newOnes = [];
        
        const checks = [
            { id: 'first_ride', condition: game.stats.trailsCompleted === 1 },
            { id: 'century', condition: game.totalMiles >= 100 },
            { id: 'five_trails', condition: game.stats.trailsCompleted >= 5 },
            { id: 'ten_trails', condition: game.stats.trailsCompleted >= 10 },
            { id: 'close_call', condition: game.battery < 5 && game.screen === 'trail_complete' },
            { id: 'perfect', condition: game.eventsThisTrail.filter(e => e.effect?.battery < 0).length === 0 && game.screen === 'trail_complete' },
            { id: 'long_haul', condition: game.currentTrail?.length >= 20 },
            { id: 'speed_run', condition: game.dayTrailsCompleted >= 3 },
            { id: 'explorer', condition: game.stats.statesVisited.length >= 3 },
            { id: 'all_states', condition: game.stats.statesVisited.length >= 6 },
            { id: 'shopper', condition: game.stats.itemsBought >= 10 },
            { id: 'collector', condition: game.inventory.length >= 8 },
            { id: 'charger_user', condition: game.stats.chargersUsed >= 5 },
            { id: 'survivor', condition: game.stats.negativeEvents >= 10 },
            { id: 'wealthy', condition: game.score >= 1000 },
            { id: 'helper', condition: game.stats.helpedRiders >= 3 },
            { id: 'rainy_day', condition: game.weather?.name === 'Rain' && game.screen === 'trail_complete' }
        ];
        
        checks.forEach(check => {
            if (check.condition && !game.achievements.some(a => a.id === check.id)) {
                const achievement = ACHIEVEMENTS.find(a => a.id === check.id);
                if (achievement) {
                    game.achievements.push(achievement);
                    newOnes.push(achievement);
                }
            }
        });
        
        return newOnes;
    }

    function goToShop() {
        game.screen = 'shop';
        render();
    }

    function buyItem(itemId, price) {
        if (game.score < price) return;
        
        const item = ITEMS[itemId];
        if (!item) return;
        
        game.score -= price;
        game.stats.itemsBought++;
        
        if (item.equipped) {
            game.equipped.push(itemId);
        } else {
            addToInventory(itemId, 1);
        }
        
        playSound('buy');
        checkAchievements();
        render();
    }

    function addToInventory(itemId, count = 1) {
        const existing = game.inventory.find(i => i.id === itemId);
        if (existing && ITEMS[itemId]?.stackable) {
            existing.count += count;
        } else if (game.inventory.length < game.maxInventory) {
            game.inventory.push({ id: itemId, count: count });
        }
    }

    function useItem(index) {
        const item = game.inventory[index];
        if (!item) return;
        
        const itemData = ITEMS[item.id];
        if (!itemData) return;
        
        // Apply effect
        if (itemData.effect.battery) {
            game.battery = Math.min(100, game.battery + itemData.effect.battery);
        }
        
        // Remove from inventory
        item.count--;
        if (item.count <= 0) {
            game.inventory.splice(index, 1);
        }
        
        playSound('use');
        render();
    }

    function findCharging() {
        game.screen = 'charging';
        render();
    }

    function charge(minutes) {
        const chargeAmount = minutes === 30 ? 40 : minutes === 60 ? 70 : 100 - game.battery;
        game.battery = Math.min(100, game.battery + chargeAmount);
        game.stats.chargersUsed++;
        game.time += minutes / 60;
        
        playSound('charge');
        checkAchievements();
        game.screen = 'hub';
        render();
    }

    function abandonTrail() {
        game.screen = 'hub';
        render();
    }

    function backToHub() {
        game.screen = 'hub';
        render();
    }

    function endDay() {
        game.day++;
        game.dayTrailsCompleted = 0;
        game.time = 8;
        game.battery = Math.min(100, game.battery + 30); // Partial overnight charge
        generateWeather();
        playSound('rest');
        saveGame();
        render();
    }

    function generateWeather() {
        const weatherTypes = Object.keys(WEATHER);
        const randomWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
        game.weather = WEATHER[randomWeather];
    }

    function getTimeString() {
        const hour = Math.floor(game.time);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
        return `${displayHour}:00 ${ampm}`;
    }

    function getTrailNarrative(trail, progress) {
        const pct = progress / trail.length;
        const narratives = [
            `You're just getting started on the ${trail.surface.toLowerCase()} trail. The path stretches ahead.`,
            `The ${trail.state} scenery is beautiful. You settle into a comfortable rhythm.`,
            `About halfway there! The trail winds through ${trail.surface === 'Paved' ? 'smooth pavement' : 'natural terrain'}.`,
            `You can sense the end approaching. The final stretch lies ahead.`,
            `Almost there! Just a little more to the finish.`
        ];
        const index = Math.min(Math.floor(pct * 5), 4);
        return narratives[index];
    }

    // ===================
    // SAVE/LOAD
    // ===================

    function saveGame() {
        try {
            localStorage.setItem(CONFIG.saveKey, JSON.stringify(game));
            console.log('Game saved!');
        } catch (e) {
            console.error('Save failed:', e);
        }
    }

    function loadGame() {
        try {
            const saved = localStorage.getItem(CONFIG.saveKey);
            if (saved) {
                game = JSON.parse(saved);
                render();
            }
        } catch (e) {
            console.error('Load failed:', e);
        }
    }

    function hasSavedGame() {
        return localStorage.getItem(CONFIG.saveKey) !== null;
    }

    function checkForSavedGame() {
        // Just check, don't auto-load
    }

    // ===================
    // SOUND
    // ===================

    function toggleSound() {
        game.soundEnabled = !game.soundEnabled;
        document.getElementById('sound-btn').classList.toggle('active', game.soundEnabled);
        document.getElementById('sound-btn').textContent = game.soundEnabled ? 'üîä' : 'üîá';
    }

    function playSound(type) {
        if (!game.soundEnabled) return;
        // Sound effects would go here - using Web Audio API or audio files
        // For now, just console log
        console.log(`üîä Sound: ${type}`);
    }

    // ===================
    // MODALS
    // ===================

    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal(event) {
        if (!event || event.target === document.getElementById('modal-overlay')) {
            document.getElementById('modal-overlay').classList.remove('active');
        }
    }

    function showHelp() {
        showModal('How to Play', `
            <div style="line-height: 1.8;">
                <h3 style="color: var(--primary); margin-bottom: 10px;">üéØ Goal</h3>
                <p>Ride as many trails as possible! Manage your battery, collect gear, and earn achievements.</p>
                
                <h3 style="color: var(--primary); margin: 15px 0 10px;">üîã Battery</h3>
                <p>Your battery drains as you ride. Different riding modes use different amounts. Don't let it hit 0%!</p>
                
                <h3 style="color: var(--primary); margin: 15px 0 10px;">üéí Inventory</h3>
                <p>Click items to use them. Buy more at shops using your points.</p>
                
                <h3 style="color: var(--primary); margin: 15px 0 10px;">üå¶Ô∏è Weather</h3>
                <p>Weather affects battery drain. Rain and wind make things harder!</p>
                
                <h3 style="color: var(--primary); margin: 15px 0 10px;">üíæ Saving</h3>
                <p>Your game auto-saves after completing trails. Click Save anytime to save manually.</p>
            </div>
        `);
    }

    // ===================
    // KEYBOARD
    // ===================

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    // ===================
    // START
    // ===================

    init();
    console.log('‚ö° Trail Quest loaded!');
    </script>
</body>
</html>
